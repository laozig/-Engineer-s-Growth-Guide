# 15. 更新管理 (WSUS)

在企业环境中，对 Windows 更新进行集中管理至关重要。让每台计算机都自由地连接到 Microsoft Update 会带来诸多问题：占用大量互联网带宽、无法控制更新的安装时机（可能导致意外重启）、无法测试更新的兼容性。Windows Server Update Services (WSUS) 正是解决这些问题的微软官方解决方案。

---

### 15.1 WSUS 的工作原理

1.  **同步 (Synchronization)**:
    -   你设置的 WSUS 服务器会连接到 Microsoft Update，将你选择的产品（如 Windows 11, Office 2019）和分类（如关键更新, 安全更新）的**更新元数据**（即更新列表，而非更新文件本身）下载下来。

2.  **批准 (Approval)**:
    -   管理员在 WSUS 控制台中审查这些更新。
    -   管理员**批准**需要部署的更新，并将其分配给相应的计算机组。

3.  **下载 (Download)**:
    -   WSUS 服务器仅下载被**批准**的更新的实际文件。

4.  **分发 (Distribution)**:
    -   域内的客户端计算机（通过组策略配置）不再连接到 Microsoft Update，而是连接到你内部的 WSUS 服务器。
    -   客户端会检测到被批准的更新，然后从 WSUS 服务器下载并安装它们。

**核心优势**:
-   **节省带宽**: 所有更新只需由 WSUS 服务器下载一次。
-   **完全控制**: 你可以精确控制哪些更新被安装、何时安装。
-   **测试与部署环**: 你可以创建不同的计算机组（如"测试组"、"生产组"），先将更新批准给测试组，验证无误后再批准给生产组。
-   **报告**: WSUS 提供报告功能，让你了解网络中所有计算机的更新状态。

---

### 15.2 安装 WSUS 角色

1.  **服务器管理器** -> `添加角色和功能`。
2.  **服务器角色**: 勾选 `Windows Server Update Services`。
3.  **角色服务**:
    -   **WID 数据库 (WID Connectivity)**: 使用 Windows 内置数据库。适用于大多数中小型部署。
    -   **数据库 (SQL Server Connectivity)**: 使用一个独立的 SQL Server 实例。适用于需要更高性能的大型部署。
    -   **WSUS 服务**: 核心服务，必须勾选。
4.  **内容**:
    -   指定一个**本地路径**来存储下载的更新文件。**此路径必须在一个足够大的 NTFS 卷上**（建议至少 100GB 起步）。**不要使用系统盘 (`C:`)**。
5.  **Web 服务器角色 (IIS)**: WSUS 需要 IIS，向导会自动为你选择所需的 IIS 组件，保持默认即可。
6.  完成安装。

---

### 15.3 配置 WSUS

安装完成后，需要在服务器管理器的通知区域**启动安装后任务**。这会完成数据库和内容文件夹的最终配置。

1.  **打开 WSUS 控制台**:
    -   `服务器管理器` -> `工具` -> `Windows Server Update Services`。
2.  **首次配置向导**:
    -   **上游服务器**: 选择 `从 Microsoft Update 同步`。
    -   **代理服务器**: 如果你的网络需要通过代理访问互联网，在此配置。
    -   **连接到上游服务器**: 点击 `开始连接`，WSUS 会与微软服务器通信，获取可用产品和分类的信息。
    -   **选择语言**: 只选择你环境中需要的语言（如 `English` 和 `中文(简体)`)，减少不必要的下载。
    -   **选择产品**: **只选择你环境中实际拥有的产品**。例如，如果你只有 Windows 11 和 Office 2021，就不要勾选 Windows 10 或 Office 2016。选择过多是导致 WSUS 磁盘空间爆炸的主要原因。
    -   **选择分类**: 通常建议选择 `关键更新`、`安全更新`、`定义更新` 和 `更新汇总`。
    -   **配置同步计划**: 选择每天自动同步一次，通常在凌晨。
3.  完成向导后，WSUS 会开始第一次**手动同步**。这会花费较长时间。

---

### 15.4 配置客户端 (通过组策略)

1.  **创建计算机组**:
    -   在 WSUS 控制台中，展开你的服务器 -> `计算机`。
    -   右键点击 `所有计算机`，选择 `添加计算机组`（例如 `Workstations-Test`, `Workstations-Prod`）。
2.  **配置 GPO**:
    -   打开 `组策略管理控制台 (gpmc.msc)`。
    -   创建一个新的 GPO（或编辑现有的），并链接到包含你要管理的计算机的 OU。
    -   导航到 `计算机配置 -> 策略 -> 管理模板 -> Windows 组件 -> Windows 更新`。
3.  **关键策略设置**:
    -   **`配置自动更新`**:
        -   **启用**。
        -   配置选项: `4 - 自动下载并计划安装` 是最常用的。
        -   计划安装日: 选择 `每天` 或每周的某天。
        -   计划安装时间: 选择一个非工作时间（如 `03:00`）。
    -   **`指定 Intranet Microsoft 更新服务位置`**:
        -   **启用**。
        -   在两个框中都输入你的 WSUS 服务器地址，格式为 `http://YourWSUSServerName:8530`。（8530 是默认 HTTP 端口）。
    -   **`启用客户端目标`**:
        -   **启用**。
        -   在框中输入你在 WSUS 中创建的计算机组的名称（如 `Workstations-Test`）。这会让客户端自动归入正确的组。

客户端在下次刷新组策略后，就会开始联系 WSUS 服务器并汇报状态。你可以在 WSUS 控制台的计算机组中看到它们。

---

### 15.5 日常管理

-   **批准更新**:
    -   在 WSUS 控制台中，导航到 `更新` -> `所有更新`。
    -   将视图过滤为 `状态: 未批准` 和 `需要: 任何`。
    -   选中要批准的更新，右键 -> `批准...`。
    -   为你的计算机组（如 `Workstations-Test`）批准安装。
-   **查看报告**:
    -   WSUS 提供了内置的报告功能，可以查看每台计算机或每个更新的详细状态。
-   **服务器清理向导**:
    -   这是一个**必须定期运行**的工具，用于清理过时的、被取代的更新，删除不再需要的更新文件，回收磁盘空间。建议每月运行一次。 