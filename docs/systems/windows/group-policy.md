# 14. 组策略 (GPO)

组策略 (Group Policy) 是 Active Directory 环境中最重要的配置管理工具。它允许管理员对域内的**用户**和**计算机**进行集中的、强制性的配置。通过组策略，你可以定义和控制程序、网络设置、安全选项等几乎所有的 Windows 系统配置。

---

### 14.1 核心概念

-   **组策略对象 (Group Policy Object, GPO)**:
    -   一个虚拟的对象，其中包含了一系列的策略设置。例如，一个名为 "Password Policy GPO" 的对象可能包含了密码长度、复杂性和过期时间等所有相关的设置。

-   **组策略管理控制台 (Group Policy Management Console, GPMC)**:
    -   `gpmc.msc`，是用于创建、编辑、链接和管理 GPO 的主要工具。

-   **链接 (Linking)**:
    -   GPO 本身不执行任何操作，直到它被**链接**到一个 Active Directory 容器。你可以将 GPO 链接到：
        -   **站点 (Site)**: 影响某个物理站点的所有用户和计算机。
        -   **域 (Domain)**: 影响整个域。
        -   **组织单位 (OU)**: **最常用、最推荐的链接级别**。影响该 OU 及其子 OU 内的所有用户和计算机。

-   **策略应用顺序 (LSDOU)**:
    1.  **L - 本地 (Local)**: 首先应用本地计算机的策略。
    2.  **S - 站点 (Site)**: 其次应用链接到站点的 GPO。
    3.  **D - 域 (Domain)**: 接着应用链接到域的 GPO。
    4.  **O - 组织单位 (OU)**: 最后应用链接到 OU 的 GPO。如果有嵌套的 OU，会从上层 OU 到下层 OU 依次应用。
    -   **规则**: 后应用的策略会**覆盖**先应用的策略。这意味着链接到 OU 的策略优先级最高。

-   **计算机配置 vs. 用户配置**:
    -   每个 GPO 都包含两个主要部分：
        -   **计算机配置**: 在计算机**启动**时应用，并且对登录到该计算机的所有用户生效。例如，安装特定软件、配置防火墙规则。
        -   **用户配置**: 在用户**登录**时应用，并且跟随该用户到他登录的任何一台计算机。例如，映射网络驱动器、设置桌面背景。

---

### 14.2 GPO 的处理

-   **继承 (Inheritance)**: 默认情况下，子 OU 会继承上层 OU、域和站点链接的所有 GPO。
-   **阻止继承 (Block Inheritance)**: 你可以在一个 OU 上设置"阻止继承"，使其不再继承来自上层的 GPO。**这是一个应谨慎使用的功能**，因为它会使策略排查变得复杂。
-   **强制 (Enforced)**: 你可以在一个 GPO 链接上设置"强制"（也叫"不得覆盖"），使其无法被下层 OU 的"阻止继承"所阻挡，也无法被其他 GPO 覆盖。**这是一个应极力避免使用的"核武器"选项**，它会严重破坏策略应用的逻辑性。

---

### 14.3 使用 GPMC 管理组策略

#### 创建和编辑 GPO

1.  打开 `gpmc.msc`。
2.  展开你的林和域，找到 `组策略对象 (Group Policy Objects)` 容器。
3.  右键点击该容器，选择 `新建`，并为你的 GPO 命名（例如 `Desktop Settings GPO`）。
4.  右键点击新创建的 GPO，选择 `编辑`。这将打开**组策略管理编辑器**。
5.  在编辑器中，你可以在 `计算机配置` -> `策略` -> `管理模板` 和 `用户配置` -> `策略` -> `管理模板` 下找到数千个可配置的设置。
    -   *示例*: 要强制所有用户使用特定的屏幕保护程序，可以导航到 `用户配置 -> 策略 -> 管理模板 -> 控制面板 -> 个性化`，然后启用并配置 `强制使用特定的屏幕保护程序` 策略。

#### 链接 GPO

1.  在 GPMC 中，找到你想要应用策略的 OU。
2.  右键点击该 OU，选择 `链接现有 GPO...`。
3.  在弹出的对话框中，选择你之前创建的 GPO。

---

### 14.4 强制刷新组策略

-   **计算机策略**默认每 90 分钟（有 0-30 分钟的随机偏移量）在后台刷新一次。
-   **用户策略**也是如此。
-   当你在 DC 上更改了 GPO 后，需要等待这个刷新周期，或者在客户端计算机上**手动强制刷新**。

**强制刷新命令 (在客户端上运行)**:
```cmd
gpupdate /force
```
该命令会立即重新应用所有适用的组策略。

---

### 14.5 策略建模和结果

GPMC 提供了两个强大的故障排查工具：

-   **组策略建模 (Group Policy Modeling)**:
    -   也叫"What-If 分析"。
    -   允许你**模拟**将一个用户登录到一台计算机上时，会应用哪些 GPO。
    -   你可以在不实际更改任何内容的情况下，预测策略变更的后果。

-   **组策略结果 (Group Policy Results)**:
    -   也叫"RSOP (Resultant Set of Policy)"。
    -   它会连接到一台**在线的**客户端计算机，并生成一份详细的报告，告诉你该计算机和当前登录的用户**实际**应用了哪些 GPO，以及每个设置的最终值和它来自哪个 GPO。
    -   **这是排查"为什么某个设置没有生效"等问题的首选工具**。

**最佳实践**:
-   **一个 GPO 做一件事**: 避免创建一个包含所有设置的"巨型 GPO"。最好是创建多个功能单一的 GPO（如一个管密码策略，一个管桌面壁纸，一个管软件安装），这样更易于管理和排查。
-   **不要在"默认域策略"和"默认域控制器策略"中添加额外设置**: 这两个 GPO 有特殊用途。应创建新的 GPO 来实施你的配置。
-   **优先在 OU 层面链接 GPO**: 这是最灵活、最清晰的管理方式。
-   **命名清晰**: 为 GPO 和 OU 起一个描述性的名称，让人能一眼看出其用途。 