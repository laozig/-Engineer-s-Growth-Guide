# 5. 文件系统与权限

Windows 使用 NTFS (New Technology File System) 作为其主要的现代文件系统。NTFS 的一个核心特性是它强大的**访问控制列表 (Access Control List, ACL)** 模型，它允许管理员对文件和文件夹的访问权限进行精细的控制。

---

### 5.1 NTFS 权限简介

NTFS 权限决定了用户或组能够对文件或文件夹执行哪些操作。这些权限是累加的，但"拒绝"权限的优先级最高。

#### 标准权限

当你通过 GUI 查看文件或文件夹的权限时，看到的是一组**标准权限**，它们是**特殊权限**的预设组合。

-   **完全控制 (Full Control)**: 允许用户读取、写入、修改、执行、更改权限和取得所有权。
-   **修改 (Modify)**: 允许读取、写入、修改和删除文件/文件夹。
-   **读取和执行 (Read & Execute)**: 允许查看文件内容、运行可执行文件。
-   **列出文件夹内容 (List Folder Contents)**: (仅适用于文件夹) 允许查看文件夹中的文件和子文件夹列表。
-   **读取 (Read)**: 允许打开和查看文件内容。
-   **写入 (Write)**: 允许创建新文件和向文件写入数据。

#### 特殊权限 (高级权限)

点击权限设置中的"高级"按钮，可以配置更精细的**特殊权限**。例如，"删除"和"删除子文件夹及文件"是独立的特殊权限，它们被包含在"修改"和"完全控制"标准权限中。

#### 权限的核心原则

-   **权限累加**: 用户最终的有效权限是其**自身权限**与**所属所有组权限**的总和。例如，如果用户 A 对某文件有"读取"权限，他所属的"工程师"组有"写入"权限，那么用户 A 的最终有效权限就是"读取"+"写入"（即"修改"）。
-   **"拒绝"权限优先**: **拒绝 (Deny)** 权限会覆盖所有其他允许 (Allow) 权限。如果用户属于两个组，一个组被允许访问，另一个组被拒绝访问，那么该用户最终将被**拒绝**访问。因此，应谨慎使用"拒绝"，优先考虑"不设置允许权限"。
-   **继承 (Inheritance)**: 默认情况下，子文件夹和文件会**继承**其父文件夹的权限设置。这大大简化了权限管理。你可以在子对象上禁用继承来设置独立的权限。

---

### 5.2 使用 GUI 管理权限

1.  **访问权限设置**:
    -   右键点击文件或文件夹，选择 `属性 (Properties)`。
    -   切换到 `安全 (Security)` 选项卡。

2.  **查看权限**:
    -   上半部分 `组或用户名` 列出了对该对象拥有权限的主体（用户或组）。
    -   选择一个主体后，下半部分会显示其拥有的标准权限。

3.  **编辑权限**:
    -   点击 `编辑 (Edit...)` 按钮。
    -   你可以：
        -   **添加 (Add...)**: 添加一个新的用户或组来分配权限。
        -   **删除 (Remove)**: 移除一个已有的主体及其所有权限。
        -   **修改权限**: 选中一个主体，然后在下方的权限列表中勾选或取消勾选 `允许 (Allow)` 或 `拒绝 (Deny)`。

4.  **高级设置**:
    -   点击 `高级 (Advanced)` 按钮进入高级安全设置。
    -   在这里你可以：
        -   **禁用继承 (Disable inheritance)**: 断开与父文件夹的权限关联，从而设置独立的权限。
        -   **查看有效访问 (Effective Access)**: 这是一个非常有用的工具，可以用来查看**特定用户**对该对象的最终有效权限，系统会自动计算其所有组权限的累加结果。
        -   **更改所有权 (Owner)**: 文件的所有者默认拥有修改其权限的能力。管理员可以取得任何文件的所有权。

---

### 5.3 使用 PowerShell 管理权限 (icacls)

虽然 PowerShell 有 `Get-Acl` 和 `Set-Acl` cmdlet，但对于日常管理，更简单、更常用的是传统的命令行工具 `icacls`。

**基本语法**: `icacls <文件名/文件夹名> /grant <用户/组>:(权限)`

-   **查看权限**:
    ```powershell
    icacls C:\data\report.docx
    ```

-   **授予权限**:
    ```powershell
    # 授予 jdoe 用户对 report.docx 的修改权限
    icacls C:\data\report.docx /grant jdoe:M

    # 授予 "Engineers" 组对整个 C:\data 目录及其子文件的完全控制权
    # (OI) - 对象继承, (CI) - 容器继承
    icacls C:\data /grant "Engineers":(OI)(CI)F
    ```
    *权限代码*: `F` (完全控制), `M` (修改), `RX` (读取和执行), `R` (读取), `W` (写入)。

-   **移除权限**:
    ```powershell
    # 移除 jdoe 用户的所有已授予的权限
    icacls C:\data\report.docx /remove jdoe
    ```

-   **拒绝权限**:
    ```powershell
    # 明确拒绝 jdoe 用户对文件的写入权限 (谨慎使用!)
    icacls C:\data\report.docx /deny jdoe:(W)
    ```

-   **保存和恢复权限**:
    ```powershell
    # 将 C:\data 目录的 ACL 保存到文件中
    icacls C:\data /save C:\temp\data_acl.txt /T

    # 从文件恢复 ACL 到 C:\data 目录
    icacls C:\data /restore C:\temp\data_acl.txt
    ```

---

### 5.4 最佳实践

-   **对组分配权限**: 这是最重要的原则。**始终将权限分配给组，然后将用户添加到组中**。这样，当需要修改权限时，你只需要修改组的权限，而不需要逐一修改每个用户的权限。当新员工入职时，只需将其加入正确的组即可。
-   **使用文件夹来组织数据和权限**: 将需要相同权限级别的数据放在同一个文件夹中，然后对该文件夹设置权限，让其中的文件和子文件夹继承。
-   **避免使用"拒绝"**: 除非绝对必要，否则不要使用"拒绝"权限。通过不授予"允许"权限来达到限制访问的目的，这样更简单、更不容易出错。
-   **定期审计**: 使用"有效访问"工具或脚本定期检查关键文件和文件夹的权限，确保没有过度的权限分配。
-   **从"无权限"开始**: 在设置共享文件夹或新数据卷时，最好的做法是先移除所有默认权限（如 `Users` 组），然后从零开始，精确地添加你需要的组和权限。 