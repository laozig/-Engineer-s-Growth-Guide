# 19. 远程桌面服务 (RDS)

远程桌面服务 (Remote Desktop Services, RDS) 是 Windows Server 的一个核心角色，它允许用户连接到和控制在远程服务器上运行的虚拟桌面、基于会话的桌面以及应用程序。这对于实现集中化管理、支持移动办公和提供对特定应用程序的访问至关重要。

---

### 19.1 RDS 的核心使用场景

1.  **基于会话的桌面 (Session-Based Desktops)**:
    -   多个用户同时连接到一台强大的服务器，并共享其资源。
    -   每个用户都有自己独立的、隔离的桌面会话。
    -   这是最传统的 RDS 部署方式，成本效益高，管理简单。
    -   **适用场景**: 标准化的办公环境，所有用户使用相同的应用程序集。

2.  **虚拟桌面基础架构 (VDI)**:
    -   每个用户被分配一个完整的、独立的虚拟机 (VM) 作为其桌面。
    -   与基于会话的方式相比，VDI 提供了更好的应用程序兼容性和用户隔离性，但成本更高，管理更复杂。
    -   **适用场景**: 需要安装特定或不兼容软件的开发人员、测试人员；对性能和隔离性有更高要求的用户。

3.  **RemoteApp**:
    -   不发布整个桌面，只发布单个应用程序。
    -   用户在本地计算机上启动 RemoteApp，但该程序实际上在远程服务器上运行。用户体验就像在运行本地程序一样。
    -   **适用场景**: 向用户交付一个或多个特定的业务应用程序，而无需在用户的设备上安装和维护它们。

---

### 19.2 RDS 的核心组件角色

一个完整的 RDS 部署通常由以下几个角色组成：

-   **RD 连接代理 (RD Connection Broker)**:
    -   RDS 部署的"大脑"。
    -   负责处理用户连接请求，将用户连接到他们现有的会话或分配一个新的会话/桌面。
    -   实现负载均衡和会话重新连接。

-   **RD 会话主机 (RD Session Host)**:
    -   这是用户实际连接并运行其会话或 RemoteApp 的服务器。
    -   在一个部署中可以有多台会话主机服务器，以实现负载均衡和高可用性。

-   **RD 虚拟化主机 (RD Virtualization Host)**:
    -   在 VDI 场景中，这是运行 Hyper-V 和用户桌面虚拟机的服务器。

-   **RD Web 访问 (RD Web Access)**:
    -   提供一个基于 Web 的门户，用户可以通过浏览器找到并启动他们的会话桌面或 RemoteApp。

-   **RD 网关 (RD Gateway)**:
    -   允许外部用户（在互联网上）通过 HTTPS (端口 443) 安全地连接到内部的 RDS 资源，而无需建立 VPN 连接。

-   **RD 授权 (RD Licensing)**:
    -   负责管理连接到 RDS 环境所需的许可证 (RDS CALs - 客户端访问许可证)。
    -   在部署超过 120 天的试用期后，这是一个**必需**的角色。

---

### 19.3 部署一个基本的基于会话的 RDS

1.  **启动 RDS 安装**:
    -   在**服务器管理器**中，`添加角色和功能`。
    -   选择 `远程桌面服务安装`。
    -   选择 `标准部署`（提供最大的灵活性）或 `快速启动`（将所有角色安装在一台服务器上，适合测试）。这里我们以**标准部署**为例。
    -   选择 `基于会话的桌面部署`。

2.  **部署角色服务**:
    -   向导会要求你为 **RD 连接代理**、**RD Web 访问** 和 **RD 会话主机** 指定目标服务器。在小型部署中，前两个角色可以安装在同一台服务器上，而会话主机通常是独立的服务器。
    -   为每个角色选择服务器后，点击部署。服务器可能会在安装过程中重启。

3.  **配置 RD 授权**:
    -   在另一台服务器上（或连接代理服务器上）安装 **RD 授权** 角色。
    -   打开 `远程桌面授权管理器`。
    -   **激活服务器**: 右键点击服务器名称 -> `激活服务器`，完成向导。
    -   **安装许可证**: 右键点击服务器名称 -> `安装许可证`，输入你购买的 RDS CALs 的信息。
    -   **配置部署使用授权服务器**: 打开 `服务器管理器` -> `远程桌面服务` -> `概述`。在 `部署概述` 中，点击 `任务` -> `编辑部署属性`。转到 `RD 授权` 选项卡，选择授权模式 (`每用户` 或 `每设备`)，并指定你的授权服务器。

4.  **创建会话集合**:
    -   集合是一组共享的 RD 会话主机服务器。
    -   在 `服务器管理器` -> `远程桌面服务` -> `集合` 中，点击 `任务` -> `创建会话集合`。
    -   为集合命名，选择要包含的 RD 会话主机服务器，指定允许连接的用户组。
    -   完成向导。

5.  **发布 RemoteApp (可选)**:
    -   在会话集合的属性中，你可以选择发布 RemoteApp 程序。

现在，用户可以通过访问 RD Web 访问的 URL (例如 `https://yourserver.domain.com/RDWeb`) 或配置其远程桌面客户端来连接到新的 RDS 环境。 