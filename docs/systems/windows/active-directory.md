# 9. Active Directory 域服务

Active Directory Domain Services (AD DS) 是 Windows Server 网络的核心组件。它提供了一个集中的目录服务，用于管理用户、计算机、组以及其他网络资源。理解 AD DS 是成为一名合格的 Windows 系统管理员的必经之路。

---

### 9.1 核心概念

-   **域 (Domain)**:
    -   一个管理边界，域内的所有对象（用户、计算机等）都遵循该域的管理策略。
    -   例如 `corp.example.com`。

-   **域控制器 (Domain Controller, DC)**:
    -   运行 AD DS 角色的 Windows 服务器。
    -   存储并复制域的目录数据库（`ntds.dit` 文件）。
    -   负责处理用户的登录请求、身份验证和策略实施。
    -   为了高可用性，一个域中至少应有**两台**域控制器。

-   **林 (Forest)**:
    -   一个或多个域的集合。林中的第一个域被称为"林根域 (Forest Root Domain)"。
    -   林是 AD DS 的最高级容器，也是安全边界。

-   **组织单位 (Organizational Unit, OU)**:
    -   域内的一个容器，可以包含用户、组、计算机和其他 OU。
    -   **主要用途**:
        1.  **委派管理权限**: 你可以给某个用户组管理特定 OU 的权限，而不用授予他们整个域的管理权限。
        2.  **应用组策略 (GPO)**: 组策略可以直接链接到 OU 上，从而对该 OU 内的所有对象生效。

-   **组策略对象 (Group Policy Object, GPO)**:
    -   一系列配置设置的集合（如禁用 USB 驱动器、强制屏保程序），可以应用到用户和计算机上。将在后续章节详细介绍。

-   **用户和计算机账户**:
    -   与本地账户不同，域账户存储在 DC 上，允许用户登录到域内任何一台计算机。

---

### 9.2 安装 Active Directory 域服务角色

**前提**:
-   一台 Windows Server 服务器。
-   为该服务器配置一个**静态 IP 地址**。DC 的 IP 地址决不能更改。
-   将该服务器的 DNS 设置为指向自身（`127.0.0.1`），因为安装 AD DS 的同时会安装 DNS 服务器角色。

**步骤 (使用 GUI)**:
1.  **打开服务器管理器**:
2.  **添加角色和功能**:
    -   点击 `管理 (Manage)` -> `添加角色和功能 (Add Roles and Features)`。
    -   安装类型选择 `基于角色或基于功能的安装`。
    -   选择当前服务器。
3.  **选择服务器角色**:
    -   勾选 `Active Directory 域服务 (Active Directory Domain Services)`。
    -   在弹出的窗口中，点击 `添加功能 (Add Features)` 以包含所需的管理工具。
4.  **功能**: 直接点击"下一步"。
5.  **确认**: 查看摘要信息，然后点击 `安装`。

---

### 9.3 将服务器提升为域控制器

角色安装完成后，你需要在服务器管理器右上角的**通知区域**（小旗子图标）看到一个黄色的感叹号。

1.  **启动提升向导**:
    -   点击通知，选择 `将此服务器提升为域控制器 (Promote this server to a domain controller)`。

2.  **部署配置**:
    -   这是最关键的一步。你有三个选项：
        -   `将域控制器添加到现有域`: 如果你已经有一个域，这是添加第二台 DC 的选项。
        -   `在新林中添加新域`: 如果这是你现有林中的第一个子域或树域。
        -   **`添加新林 (Add a new forest)`**: **对于第一个域控制器，必须选择此项**。
    -   **根域名**: 为你的林指定一个根域名，例如 `ad.yourcompany.local`。（`.local` 后缀常用于内部网络，以避免与公共域名冲突）。

3.  **域控制器选项**:
    -   **林/域功能级别**: 决定了你的 AD 林和域支持的特性，以及可以加入的 DC 的最低操作系统版本。通常保持默认即可。
    -   **DNS 服务器**: 必须勾选。
    -   **目录服务还原模式 (DSRM) 密码**: **务必设置一个强密码并妥善保管**。此密码用于在 AD 数据库损坏时进行还原。

4.  **DNS 选项**: 如果是第一个 DC，可能会有一个关于 DNS 委派的警告，可以安全地忽略。

5.  **其他选项**:
    -   **NetBIOS 域名**: 通常会自动根据你的域名生成（例如 `AD`），保持默认即可。

6.  **路径**: 指定 NTDS 数据库、日志文件和 SYSVOL 文件夹的位置。建议将它们放在与操作系统不同的、独立的磁盘上以提高性能。

7.  **查看选项并安装**:
    -   检查所有配置，然后点击 `安装`。
    -   服务器会自动完成配置并**重启**。

---

### 9.4 验证安装

服务器重启后，你的网络环境就发生了根本性的变化。

-   **登录**: 你现在需要使用域管理员账户登录，格式为 `域名\用户名`（例如 `AD\Administrator`）。
-   **管理工具**:
    -   在开始菜单的"Windows 管理工具"中，你会看到一套新的工具：
        -   **Active Directory 用户和计算机 (Active Directory Users and Computers)**: 管理用户、组、计算机和 OU 的主要工具。
        -   **Active Directory 站点和服务 (Active Directory Sites and Services)**: 管理物理网络拓扑和复制。
        -   **Active Directory 域和信任关系 (Active Directory Domains and Trusts)**: 管理林和域之间的关系。
        -   **组策略管理 (Group Policy Management)**: 创建和管理 GPO。
-   **DNS 管理器**:
    -   打开 DNS 管理器，你会看到为你的域自动创建的正向查找区域，其中包含 DC 的主机 (A) 记录和服务 (SRV) 记录。

---

### 9.5 将计算机加入域

1.  在要加入域的工作站上，打开 `系统属性` (`Win + R` -> `sysdm.cpl`)。
2.  点击 `更改 (Change...)`。
3.  在 `隶属于 (Member of)` 部分，选择 `域 (Domain)`，然后输入你的域名（例如 `ad.yourcompany.local`）。
4.  点击确定后，会提示输入**有权将计算机加入域的账户**的凭据（例如域管理员 `AD\Administrator`）。
5.  成功加入后，重启计算机。现在，你可以使用任何已创建的域用户账户登录这台计算机了。 