# 11. DHCP 服务器配置

动态主机配置协议 (DHCP) 是一项基础网络服务，它可以自动为网络中的客户端设备分配 IP 地址及其他网络配置参数。在 Windows Server 上配置 DHCP 服务可以让你集中管理网络中的 IP 地址分配。

---

### 11.1 DHCP 工作流程 (DORA)

DHCP 的核心工作流程被称为 **DORA**，是四个步骤的首字母缩写：

1.  **Discover (发现)**:
    -   客户端计算机启动并连接到网络后，它会以**广播**的形式发送一个 `DHCPDISCOVER` 消息，询问"网络里有 DHCP 服务器吗？谁能给我一个 IP 地址？"

2.  **Offer (提供)**:
    -   网络上的所有 DHCP 服务器收到广播后，会检查自己地址池中是否有可用的 IP 地址。
    -   如果有，它们会向客户端发送一个 `DHCPOFFER` 消息，其中包含一个可用的 IP 地址、租期和其他配置信息，说"我有一个 IP 地址 `192.168.1.120`，你可以用。"

3.  **Request (请求)**:
    -   客户端可能会收到多个 Offer。它会选择**第一个**收到的 Offer，然后再次以广播的形式发送一个 `DHCPREQUEST` 消息，告诉所有 DHCP 服务器："我决定接受来自服务器 A 的 IP 地址 `192.168.1.120`。"
    -   广播的目的是通知其他提供了 Offer 的服务器，它们的 IP 地址未被接受，可以分配给其他客户端。

4.  **Acknowledge (确认)**:
    -   被选中的 DHCP 服务器会发送一个 `DHCPACK` 消息，确认租约，说"好的，IP 地址 `192.168.1.120` 现在正式分配给你了，租期为 8 天。"
    -   客户端收到确认后，就会配置自己的网络接口，并开始使用该 IP 地址。

---

### 11.2 安装 DHCP 服务器角色

1.  **打开服务器管理器** -> `管理` -> `添加角色和功能`。
2.  **服务器角色**: 勾选 `DHCP 服务器`，并按提示添加所需的功能。
3.  **安装**: 完成向导，点击 `安装`。

---

### 11.3 配置 DHCP 服务器

安装完成后，和 AD DS 类似，你需要在服务器管理器的通知区域完成安装后配置。

1.  **完成 DHCP 配置**:
    -   点击通知区域的 `完成 DHCP 配置`。
    -   此步骤主要是为了在 Active Directory 中**授权 (Authorize)** 该 DHCP 服务器。点击 `提交 (Commit)`，使用域管理员凭据即可。
    -   **为什么需要授权？** 这是为了防止未经授权的（恶意的）DHCP 服务器在网络中分发错误的 IP 地址。只有被授权的 DHCP 服务器才能在 AD 环境中正常工作。

2.  **打开 DHCP 管理器**:
    -   `服务器管理器` -> `工具` -> `DHCP`。
    -   或 `Win + R` -> `dhcpmgmt.msc`。

3.  **创建作用域 (Scope)**:
    -   作用域是 DHCP 服务器上可供分配的 IP 地址的连续范围。
    -   在服务器名称上右键，选择 `新建作用域`。
    -   **名称和描述**: 为作用域起一个有意义的名称，如 `Corp-Wired-Clients`。
    -   **IP 地址范围**:
        -   定义地址池的起始和结束 IP。例如 `192.168.1.100` 到 `192.168.1.200`。
        -   **子网掩码**: 系统会根据 IP 范围自动填充，请确认无误。
    -   **添加排除和延迟**:
        -   **排除**: 你可以在地址池中排除某些 IP 地址，使它们不会被分配出去。例如，你可以排除已被静态分配给打印机或交换机的地址。
    -   **租约期限**: 定义客户端可以使用一个 IP 地址多长时间。默认 8 天，对于有线网络是合理的。
    -   **配置 DHCP 选项**:
        -   向导会问你是否要现在配置最常用的 DHCP 选项。选择 `是`。
        -   **路由器 (默认网关)**: 输入你的网络网关地址，例如 `192.168.1.1`。
        -   **域名和 DNS 服务器**: 域名通常会自动填充。请确认 DNS 服务器地址是否正确指向你的域控制器。
        -   **WINS 服务器**: 这是一个过时的服务，可以直接跳过。
    -   **激活作用域**: 最后，选择 `是，我想现在激活此作用域`。

4.  **验证**:
    -   展开 `地址池`，可以看到你定义的 IP 范围。
    -   展开 `地址租用`，当有客户端获取到 IP 后，你可以在这里看到租约记录。

---

### 11.4 保留 (Reservations)

保留功能允许你为**特定的设备**（通过其 MAC 地址识别）**永久性地分配一个固定的 IP 地址**。

-   **应用场景**: 你希望某台设备（如一台非服务器但需要固定 IP 的设备）总是获取相同的 IP 地址，但又想通过 DHCP 集中管理。
-   **配置**: 在相应作用域下，右键点击 `保留` -> `新建保留`。输入保留名称、要分配的 IP 地址和设备的 MAC 地址。

---

### 11.5 DHCP 选项

DHCP 不仅能分配 IP，还能分配很多其他配置，这些被称为**选项**。

-   **服务器选项**: 应用到该服务器管理的所有作用域。
-   **作用域选项**: 只应用到当前作用域。
-   **保留选项**: 只应用到某个特定的保留客户端。

最常用的选项（如网关、DNS）已在作用域向导中配置。你可以在 `作用域选项` 上右键 -> `配置选项` 来添加或修改其他设置，如 NTP 时间服务器 (选项 042) 等。 