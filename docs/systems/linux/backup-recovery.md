# 18. 备份与恢复

数据是系统中最宝贵的资产。无论是由于硬件故障、软件错误还是人为失误，数据丢失的风险始终存在。制定并执行可靠的备份与恢复计划是系统管理中不可或缺的一环。

## 备份策略

在实施备份之前，需要先了解几种核心的备份类型：

- **完整备份 (Full Backup)**:
  - 复制所有选定的数据。
  - **优点**: 恢复最简单、最快速，因为你只需要最新的那一份备份。
  - **缺点**: 占用大量存储空间，备份过程耗时最长。

- **增量备份 (Incremental Backup)**:
  - 仅备份自**上一次备份**（无论是完整备份还是增量备份）以来发生变化的数据。
  - **优点**: 备份速度快，占用空间少。
  - **缺点**: 恢复过程最复杂。你需要先恢复最近的一次完整备份，然后按顺序应用之后所有的增量备份。

- **差异备份 (Differential Backup)**:
  - 备份自**上一次完整备份**以来发生变化的所有数据。
  - **优点**: 恢复过程比增量备份简单。你只需要恢复最近的完整备份和最近的一次差异备份。
  - **缺点**: 随着时间的推移，差异备份文件会越来越大，备份时间也会变长。

**常见策略**: 每周进行一次完整备份，每天进行一次增量或差异备份。

## 文件级备份工具

### 1. `tar` (Tape Archive)

`tar` 是 Linux 中最经典的打包归档工具。它通常与压缩工具（如 `gzip` 或 `bzip2`）结合使用，将多个文件和目录打包成一个单独的压缩文件。

**常用选项**:
- `c`: 创建一个新的归档文件。
- `x`: 从归档文件中提取文件。
- `v`: 显示详细过程 (verbose)。
- `f`: 指定归档文件的名称。
- `t`: 列出归档文件中的内容。
- `z`: 通过 gzip 进行压缩/解压缩 (`.tar.gz`)。
- `j`: 通过 bzip2 进行压缩/解压缩 (`.tar.bz2`)。
- `p`: 保留文件权限和属性。

**备份示例**:
```bash
# 将 /home/user 目录打包并用 gzip 压缩
# 创建一个名为 backup_YYYY-MM-DD.tar.gz 的文件
tar -czvpf /backups/home_user_$(date +%F).tar.gz /home/user

# 备份多个目录
tar -czvpf /backups/system_$(date +%F).tar.gz /etc /var/log /root
```

**恢复示例**:
```bash
# 将备份文件恢复到 /tmp/restore 目录
# -C 选项指定恢复的目标目录
tar -xzvpf /backups/home_user_2023-10-27.tar.gz -C /tmp/restore
```

### 2. `rsync` (Remote Sync)

`rsync` 是一个功能极其强大的文件同步工具。它通过 "delta-transfer" 算法，只传输源和目标之间有差异的部分，因此非常高效。它是执行增量备份和远程备份的理想选择。

**常用选项**:
- `a`: 归档模式，等同于 `-rlptgoD`。它递归地同步文件，并保留权限、所有权、时间戳等信息。
- `v`: 显示详细过程。
- `h`: 以人类可读的格式显示输出 (`--human-readable`)。
- `z`: 在传输过程中压缩文件数据。
- `--delete`: 删除目标目录中源目录不存在的文件。**谨慎使用！**
- `--exclude`: 排除不需要备份的文件或目录。
- `-e`: 指定用于远程传输的 shell，通常是 `ssh`。

**本地备份示例 (创建镜像)**:
```bash
# 将 /home/user 目录完整地备份到 /backups/home_user_mirror
# 这会使得目标目录与源目录完全一致
rsync -avh --delete /home/user/ /backups/home_user_mirror/
```
**注意**: 源路径最后的 `/` 很重要！
- `/home/user/` 表示复制该目录的**内容**。
- `/home/user` 表示复制该目录**本身**。

**远程备份示例 (通过 SSH)**:
```bash
# 将本地的 /var/www 目录备份到远程服务器 192.168.1.100 的 /remote_backups 目录下
rsync -avhz -e ssh /var/www/ user@192.168.1.100:/remote_backups/
```

**使用 `rsync` 实现增量备份**:
`rsync` 本身不直接创建像传统增量备份那样的多个小文件，但可以与快照式目录结合使用。你可以每天将数据 `rsync` 到一个以日期命名的目录中，并使用 `--link-dest` 选项，让未改变的文件从前一天的备份中创建硬链接，而不是重新复制。这极大地节省了空间。

## 块级备份 (裸设备备份)

块级备份直接在磁盘或分区层面操作，复制每一个数据块，而不管文件系统。这通常用于创建系统的完整镜像。

- **`dd` (Data Duplicator)**:
  一个非常强大但也很危险的工具，因为一个错误的参数就可能擦除整个磁盘。它可以逐字节地精确复制一个分区或整个硬盘。
  ```bash
  # 备份整个硬盘 sda 到另一个硬盘 sdb
  sudo dd if=/dev/sda of=/dev/sdb bs=4M status=progress

  # 创建一个硬盘的镜像文件
  sudo dd if=/dev/sda of=/backups/sda_image.img bs=4M status=progress
  ```
- **`Clonezilla`**:
  一个基于 `dd` 和其他工具的启动盘发行版。它提供了一个用户友好的文本界面来克隆磁盘和分区，是进行系统迁移或裸机恢复的优秀工具。

## 快照 (Snapshots)

一些现代的文件系统和卷管理器支持**快照**功能。快照是某个时间点上文件系统或卷状态的只读副本。创建快照几乎是瞬间完成的，并且初始不占用额外空间（采用写时复制 Copy-on-Write 技术）。

- **LVM (Logical Volume Manager)**: 可以在逻辑卷上创建快照。
- **Btrfs / ZFS**: 这类现代文件系统原生支持高效的快照功能。

快照非常适合在进行高风险操作（如系统更新、软件升级）之前创建一个快速的回滚点。

## 总结
一个健壮的备份策略通常会结合多种工具：
- 使用 `rsync` 或 LVM/ZFS 快照进行每日的快速备份。
- 使用 `tar` 定期（如每周）创建离线的、完整的归档备份。
- 在需要完整系统迁移或恢复时，考虑使用 `Clonezilla`。

定期**测试你的恢复流程**与创建备份同等重要。一个未经测试的备份等于没有备份。 