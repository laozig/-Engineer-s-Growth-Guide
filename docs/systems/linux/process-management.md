# 11. 进程管理

在 Linux 中，一个进程就是正在执行的程序的实例。系统中的每一个活动，从内核任务到用户打开的应用程序，都是通过进程来完成的。有效的进程管理对于维护系统性能和稳定性至关重要。

## 什么是进程？

- **PID (Process ID)**: 每个进程都有一个唯一的数字标识符，即进程ID。
- **PPID (Parent Process ID)**: 每个进程都是由另一个进程（父进程）创建的。PPID 就是其父进程的ID。系统中所有进程的始祖是 `init` 或 `systemd` 进程，其 PID 永远是 1。
- **用户**: 每个进程都以特定用户的身份运行，并拥有该用户的权限。

## 查看进程

### 1. `ps` (Process Status)

`ps` 命令用于显示当前正在运行的进程的快照。它有许多选项，以下是两种最常见的用法：

- **BSD 风格 (常用)**:
  ```bash
  ps aux
  ```
  - `a`: 显示所有用户的进程。
  - `u`: 以用户为中心的格式显示（显示进程所有者）。
  - `x`: 同时显示没有控制终端的进程（例如系统守护进程）。

- **System V 风格**:
  ```bash
  ps -ef
  ```
  - `-e`: 显示所有进程。
  - `-f`: 显示完整格式的列表（包含 PPID、C-time等）。

**输出解读 (`ps aux`)**:
```
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.1  16892  8624 ?        Ss   Jul15   0:02 /sbin/init
root           2  0.0  0.0      0     0 ?        S    Jul15   0:00 [kthreadd]
...
jane        1234  0.2  1.5 123456 34567 ?        Sl   10:30   0:15 /usr/bin/firefox
```
- **USER**: 进程的所有者。
- **PID**: 进程 ID。
- **%CPU**: CPU 使用率。
- **%MEM**: 内存使用率。
- **COMMAND**: 进程的命令。

### 2. `top` - 实时监控进程

`top` 命令提供了一个动态的、实时的系统进程视图。它会按 CPU 使用率对进程进行排序，并每隔几秒刷新一次。

```bash
top
```
在 `top` 界面中，你可以使用交互式命令：
- `q`: 退出 `top`。
- `k`: 向一个进程发送信号（kill），会提示你输入 PID。
- `M`: 按内存使用率排序。
- `P`: 按 CPU 使用率排序（默认）。

### 3. `htop` - 增强版的 `top`

`htop` 是 `top` 的一个更现代、更易用的替代品。它提供了彩色的、可滚动的界面，并允许你直接使用鼠标或方向键来操作。在许多系统中它不是默认安装的。
```bash
# 安装 (Debian/Ubuntu)
sudo apt install htop
# 安装 (Fedora/CentOS)
sudo dnf install htop

# 运行
htop
```

## 向进程发送信号 (`kill`)

信号 (Signals) 是在类 Unix 系统中进程间通信的一种方式，常用于控制或终止进程。`kill` 命令用于向指定 PID 的进程发送信号。

**语法**: `kill [信号] <PID>`

最常用的信号：
- **`SIGTERM` (15)**: 默认信号。这是"礼貌"的终止请求，允许进程在关闭前进行清理工作（如保存文件）。
- **`SIGKILL` (9)**: "强制杀死"。这是内核级别的终止，进程无法忽略。只有在进程对 `SIGTERM` 没有响应时才应使用。
- **`SIGHUP` (1)**: "挂起"。通常用于让守护进程重新加载其配置文件。

```bash
# 使用默认的 SIGTERM 终止进程 1234
kill 1234

# 强制杀死进程 1234
kill -9 1234
# 或者
kill -SIGKILL 1234
```

### `pkill` 和 `killall`
这两个命令允许你通过进程名而不是 PID 来终止进程。
- **`pkill`**: 通过名称或其他属性匹配进程。
  ```bash
  # 终止所有名为 'firefox' 的进程
  pkill firefox
  ```
- **`killall`**: 终止所有与指定名称完全匹配的进程。
  ```bash
  killall nginx
  ```
**警告**: 在多用户系统上使用这些命令要格外小心，以免终止其他用户的进程。

## 进程优先级 (`nice`, `renice`)

在 Linux 中，你可以影响内核的进程调度算法，通过调整进程的"nice"值来改变其优先级。
- **Nice 值**: 范围从 `-20` (最高优先级) 到 `19` (最低优先级)。默认值为 `0`。
- **`nice`**: 以指定的优先级启动一个新进程。
  ```bash
  # 以较低的优先级启动一个 CPU 密集型任务
  nice -n 10 ./my_cpu_intensive_script.sh
  ```
- **`renice`**: 修改一个已在运行的进程的优先级。
  ```bash
  # 将进程 1234 的优先级设为 5
  renice 5 1234
  ```
只有 `root` 用户可以设置负的 nice 值（即提高优先级）。

## 后台进程管理

当你从终端启动一个长时间运行的任务时，它会占据你的 Shell，你无法执行其他命令。你可以将进程放到后台运行。

- **`&`**: 在命令末尾加上 `&`，可以立即将其作为后台任务启动。
  ```bash
  ./long_running_task.sh &
  ```
- **`jobs`**: 查看当前 Shell 会话中的后台任务。
- **`fg` (Foreground)**: 将一个后台任务调回前台。
  ```bash
  # 将任务号为 1 的任务调回前台
  fg %1
  ```
- **`bg` (Background)**: 让一个已暂停（通常是按 `Ctrl+Z`）的任务在后台继续运行。
- **`nohup` (No Hang Up)**: `nohup` 命令允许一个进程在你退出 Shell 或断开 SSH 连接后继续运行。它会将所有输出重定向到一个名为 `nohup.out` 的文件中。
  ```bash
  nohup ./my_server_app.sh &
  ```

### `screen` 和 `tmux` - 终端复用器

对于需要长时间运行且需要稍后回来交互的任务（如服务器应用），`nohup` 并不理想。`screen` 和 `tmux` 是更强大的工具。它们可以创建持久化的 Shell 会话，你可以随时"脱离 (detach)"和"附加 (attach)"回来，即使断开了 SSH 连接，会话和其中的进程也会一直保持运行。

- **`tmux` (推荐)**:
  - `tmux new -s my_session`: 创建一个名为 `my_session` 的新会话。
  - 在会话中运行你的命令。
  - 按 `Ctrl+b` 然后按 `d` 来脱离会话。
  - `tmux ls`: 列出所有会话。
  - `tmux attach -t my_session`: 重新连接到会话。 