# 3. IPv6 基础

随着互联网的爆炸式增长，大约 43 亿个 IPv4 地址已基本耗尽。为了解决这个问题，互联网工程任务组 (IETF) 设计了 IPv6，它拥有一个几乎取之不尽的地址空间，并带来了许多其他改进。

---

### 3.1 为什么需要 IPv6？

-   **巨大的地址空间**: IPv6 地址是 128 位的，提供了大约 3.4 x 10^38 个地址。这个数量足以给地球上每一粒沙子都分配一个 IP 地址。
-   **简化的报头**: IPv6 的报头比 IPv4 更简单、更高效。它移除了不必要的字段并进行了优化，从而加快了路由器的处理速度。
-   **增强的安全性**: IPSec（Internet Protocol Security）被设计为 IPv6 的一个强制性组成部分（尽管后来变为可选），为网络通信提供了原生的身份验证和加密。
-   **无状态地址自动配置 (SLAAC)**: IPv6 主机可以自动生成自己的全球单播地址，无需手动配置或依赖 DHCP 服务器，极大地简化了网络管理。
-   **没有广播**: IPv6 使用更高效的多播（Multicast）和任意播（Anycast）来取代 IPv4 中的广播，减少了网络噪音。

---

### 3.2 IPv6 地址表示法

一个 IPv6 地址是一个 128 位的十六进制数。它被分成 8 组（hextets），每组 16 位（4个十六进制字符），组与组之间用冒号 (`:`) 分隔。

**完整格式**:
`2001:0db8:85a3:0000:0000:8a2e:0370:7334`

**压缩规则**:
为了简化地址的书写，有两条压缩规则：

1.  **省略前导零**: 在任何一组中，可以省略开头的零。
    -   `0db8` -> `db8`
    -   `0370` -> `370`
    -   `0000` -> `0`
    -   压缩后: `2001:db8:85a3:0:0:8a2e:370:7334`

2.  **省略连续的零**: 可以使用双冒号 (`::`) 来代替任意数量的、连续为零的组。**这个规则在一个地址中只能使用一次**，以避免歧义。
    -   `2001:db8:85a3:0:0:8a2e:370:7334` -> `2001:db8:85a3::8a2e:370:7334`
    -   `fe80:0000:0000:0000:0202:b3ff:fe1e:8329` -> `fe80::202:b3ff:fe1e:8329`

---

### 3.3 IPv6 地址类型

-   **全球单播地址 (Global Unicast Address - GUA)**:
    -   相当于 IPv4 的公网地址，全球唯一，可以在互联网上路由。
    -   通常由 `2000::/3` 前缀开始（即第一个十六进制字符是 `2` 或 `3`）。
    -   一个 GUA 通常由三部分组成：
        1.  **全球路由前缀 (Global Routing Prefix)**: 通常是 `/48`，由 ISP 分配给一个组织。
        2.  **子网 ID (Subnet ID)**: 通常是 16 位，允许组织创建 `2^16 = 65,536` 个子网。
        3.  **接口 ID (Interface ID)**: 通常是 64 位，用于标识子网中的特定主机。

-   **链路本地地址 (Link-Local Address)**:
    -   所有启用了 IPv6 的接口都必须有一个链路本地地址。
    -   它只在同一数据链路（网段）内有效，不能被路由。
    -   用于邻居发现、SLAAC 等本地通信。
    -   前缀总是 `fe80::/10`。

-   **唯一本地地址 (Unique Local Address)**:
    -   相当于 IPv4 的私有地址（如 `192.168.0.0/16`）。
    -   可以在组织内部自由使用和路由，但不能在公共互联网上路由。
    -   前缀是 `fc00::/7`。

-   **多播地址 (Multicast Address)**:
    -   用于向一组接口发送单个数据包。
    -   前缀是 `ff00::/8`。
    -   例如，`ff02::1` 表示链路上的所有节点，`ff02::2` 表示链路上的所有路由器。

---

### 3.4 接口 ID 的生成：EUI-64

接口 ID 是地址的后 64 位。除了手动配置，它通常通过 **EUI-64 (扩展唯一标识符)** 过程自动生成：

1.  **获取 MAC 地址**: 取网卡的 48 位 MAC 地址。
    -   例如: `00:0A:95:9D:68:16`
2.  **插入 FFFE**: 在 MAC 地址的中间（第三和第四字节之间）插入 `FFFE`。
    -   `000A:95FF:FE9D:6816`
3.  **翻转第 7 位**: 将第一个字节的第 7 位从 0 翻转为 1（或从 1 到 0）。
    -   `00` 的二进制是 `0000 0000`。
    -   翻转第 7 位后变成 `0000 0010`，即十六进制的 `02`。
    -   结果: `020A:95FF:FE9D:6816`

这样，一个 IPv6 主机就可以将其链路本地前缀 `fe80::/10` 与这个接口 ID 结合，形成完整的链路本地地址 `fe80::20a:95ff:fe9d:6816`。同样，当通过路由器获取到全球路由前缀和子网 ID 后，也能用同样的方式构成其全球单播地址。 