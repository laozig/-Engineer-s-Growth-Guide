# 6. 生成树协议 (Spanning Tree Protocol, STP)

为了提高网络的可靠性，网络管理员通常会在交换机之间创建冗余链路。然而，冗余在二层网络中是一把双刃剑：它虽然提供了备用路径，但也会引发致命的**二层环路 (Layer 2 Loops)**。生成树协议 (STP) 的主要任务就是在保证链路冗余的同时，防止二层环路的产生。

---

### 6.1 二层环路的问题

当交换机之间存在多条活动路径时，如果没有一种机制来控制它们，就会发生二层环路。环路会导致以下严重问题：

1.  **广播风暴 (Broadcast Storm)**:
    -   当一台主机发送一个广播帧（如 ARP 请求）时，这个帧会被交换机在环路中无限地、反复地转发。
    -   这些广播帧会迅速增殖，很快就会耗尽交换机所有的 CPU 和带宽资源，导致整个网络瘫痪。

2.  **MAC 地址表不稳定 (MAC Address Table Instability)**:
    -   交换机通过查看数据帧的源 MAC 地址来学习哪个端口连接了哪个设备。
    -   在环路中，同一个数据帧可能会从不同的端口到达同一个交换机。这会导致交换机不断地更新其 MAC 地址表，因为它认为某个设备在不同的端口之间"跳来跳去"。
    -   最终，MAC 地址表会变得极不稳定，交换机无法做出正确的转发决策。

3.  **多帧复制 (Multiple Frame Copies)**:
    -   对于单播帧，如果其目标 MAC 地址尚未被学习到，它也会像广播帧一样被泛洪。在环路中，这会导致目标主机会收到同一个数据帧的多个副本，引起应用程序的混乱。

---

### 6.2 STP 的工作原理

STP 通过**逻辑上阻塞**网络中的某些冗余端口来打破环路。它创建了一个从根桥（Root Bridge）延伸出来的、无环路的树状拓扑。如果主路径发生故障，STP 会重新计算拓扑，并激活之前被阻塞的某个端口来恢复连接。

**STP 的选举和计算过程**:

1.  **选举根桥 (Root Bridge)**:
    -   网络中会选举出一个交换机作为"根桥"。根桥是整个生成树逻辑拓扑的"根"。
    -   选举标准是 **Bridge ID (BID)**。BID 由两部分组成：`Bridge Priority` (2字节) + `MAC Address` (6字节)。
    -   **BID 最小**的交换机将成为根桥。管理员可以通过手动配置更低的 `Priority` (默认为 32768) 来影响选举结果。

2.  **在非根桥上选举根端口 (Root Port)**:
    -   网络中除了根桥以外的所有交换机（称为非根桥）都必须选举出一个"根端口"。
    -   根端口是该交换机上到达根桥**路径成本 (Path Cost) 最低**的端口。路径成本是根据链路的速度计算的（速度越快，成本越低）。
    -   根端口是该交换机用来与网络其余部分通信的主要上行端口。

3.  **在每个网段上选举指定端口 (Designated Port)**:
    -   在网络的每一个网段（即连接两台交换机的链路）上，都需要选举出一个"指定端口"。
    -   指定端口是该网段上负责转发流量的端口。通常，它是该网段中离根桥更近（路径成本更低）的那个端口。
    -   根桥上的所有端口都是指定端口。

4.  **阻塞非指定端口 (Blocking Non-Designated Ports)**:
    -   经过以上选举后，所有既不是根端口也不是指定端口的端口，都会被置于**阻塞状态 (Blocking State)**。
    -   这些被阻塞的端口就是 STP 打破环路的关键。它们虽然物理上连接着，但逻辑上不转发任何用户数据，只监听 STP 的 BPDU 报文。

**BPDU (Bridge Protocol Data Unit)**:
-   这是 STP 使用的特殊报文。交换机通过相互交换 BPDU 来进行根桥选举和端口角色计算。

---

### 6.3 STP 端口状态

-   **Blocking (阻塞)**: 不转发数据，只接收 BPDU。
-   **Listening (侦听)**: 端口开始参与 STP 计算，准备转变为转发状态。不转发数据。
-   **Learning (学习)**: 端口开始学习 MAC 地址并填充 MAC 地址表。不转发数据。
-   **Forwarding (转发)**: 端口完全激活，可以正常地发送和接收数据。
-   **Disabled (禁用)**: 端口被管理员手动关闭。

从 Blocking 到 Forwarding 的标准收敛时间大约需要 **30-50 秒**，这是一个显著的缺点。

---

### 6.4 STP 的演进

标准的 STP (802.1D) 由于其收敛速度慢等缺点，已经催生了多种改进版本：

-   **RSTP (Rapid Spanning Tree Protocol, 802.1w)**:
    -   **快速收敛**: 核心改进。通过引入新的端口角色和机制，RSTP 可以在几秒甚至毫秒内完成网络拓扑的收敛。
    -   是目前最常用的 STP 版本。

-   **PVST+ (Per-VLAN Spanning Tree Plus)**:
    -   思科私有协议。它为**每个 VLAN** 都运行一个独立的 STP 实例。
    -   **优点**: 可以在不同的 VLAN 中实现负载均衡。例如，可以让交换机 A 成为 VLAN 10 的根桥，让交换机 B 成为 VLAN 20 的根桥，从而让两个 VLAN 的流量走不同的路径。
    -   **缺点**: 消耗更多的交换机 CPU 资源。

-   **Rapid PVST+**:
    -   结合了 RSTP 的快速收敛和 PVST+ 的按 VLAN 负载均衡的优点。是现代思科网络中最推荐的 STP 模式。

-   **MSTP (Multiple Spanning Tree Protocol, 802.1s)**:
    -   一个开放标准。它允许将多个 VLAN 映射到单个 STP 实例中，是 PVST+ 的一个折中方案，既能实现负载均衡，又不会消耗过多的 CPU 资源。 