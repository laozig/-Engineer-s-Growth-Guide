# 13. BGP 基础 (BGP Fundamentals)

BGP (Border Gateway Protocol) 是支撑整个互联网运行的基石。与我们之前讨论的 RIP、EIGRP 和 OSPF 等内部网关协议（IGP）不同，BGP 是一个外部网关协议（EGP）。它的主要工作不是在自治系统（AS）内部寻找最快的路径，而是在全球数以万计的、独立的自治系统之间，根据各种复杂的策略来选择和通告路由。

---

### 13.1 BGP 的作用和特点

-   **连接互联网**: BGP 是用于在不同 ISP、大型企业和内容提供商（这些都是独立的 AS）之间交换路由信息的唯一协议。
-   **策略驱动**: BGP 的核心是**策略**。路径的选择不仅仅基于技术指标（如跳数或带宽），更多是基于商业关系、经济成本和安全策略。例如，一个 ISP 可能会优先选择通过付费客户的路径，而不是免费对等互联的路径。
-   **海量路由承载**: BGP 被设计用来处理全球互联网路由表（目前已超过 90 万条路由）的巨大规模。
-   **可靠的更新**: BGP 使用 TCP（端口 179）作为其传输层协议，确保了路由更新的可靠传输。
-   **路径矢量协议**: BGP 通常被称为"路径矢量协议"。在路由更新中，它不仅仅通告目标网络，还会附带一个到达该网络所必须经过的**完整的 AS 路径（AS_PATH）**。这个 AS_PATH 是 BGP 防止环路的核心机制。
-   **缓慢收敛**: BGP 的设计优先考虑的是稳定性和可扩展性，而不是快速收敛。其更新和收敛过程可能需要数分钟。

---

### 13.2 BGP 的两种会话类型

BGP 通过建立 TCP 会话来形成邻居关系，这种邻居关系称为**对等体 (Peer)**。

1.  **iBGP (Internal BGP)**:
    -   在**同一个 AS 内部**的 BGP 路由器之间建立的对等体关系。
    -   iBGP 的主要作用是将从外部邻居（eBGP）学到的路由信息，同步到 AS 内部的所有其他 BGP 路由器，以确保 AS 内部的路由策略一致性。
    -   **iBGP 水平分割规则**: 为了防止环路，从一个 iBGP 对等体学到的路由，**不会**再通告给任何其他的 iBGP 对等体。这意味着在同一个 AS 内部，所有 iBGP 路由器必须建立**全互联（Full Mesh）**的对等体关系（或使用路由反射器、联盟等高级技术来解决）。

2.  **eBGP (External BGP)**:
    -   在**不同 AS 之间**的 BGP 路由器之间建立的对等体关系。
    -   这是 BGP 用于在互联网上传播路由的主要方式。
    -   通常，eBGP 对等体之间是物理上直连的。

---

### 13.3 BGP 路径选择过程

当一台 BGP 路由器从多个邻居那里学习到去往同一个目标网络的多条路径时，它会通过一个复杂的、按顺序执行的**最佳路径选择算法**来决定哪条路径最优。这个过程会检查一系列的**路径属性 (Path Attributes, PA)**。

以下是一些最重要、最常用的路径属性（按选择顺序）:

1.  **WEIGHT (权重)**:
    -   **思科私有**属性，只在本地路由器上有意义，不会传递给任何邻居。
    -   **值越高越优** (0-65535)。默认情况下，本地产生的路由权重为 32768，从邻居学到的为 0。
    -   是影响路径选择的**第一道关卡**，通常用于设置本地的首选出口。

2.  **LOCAL_PREF (本地偏好)**:
    -   用于告诉一个 AS 内部的所有路由器，离开本 AS 的**首选出口**是哪一个。
    -   **值越高越优**。默认值为 100。
    -   `LOCAL_PREF` 属性只在同一个 AS 内部的 iBGP 对等体之间传递。

3.  **本地产生 (Locally Originated)**:
    -   由本路由器通过 `network` 命令或重分发产生的路由，优于从任何邻居学到的路由。

4.  **AS_PATH (AS 路径)**:
    -   **AS_PATH 列表越短越优**。这是 BGP 最基本的路径选择标准，反映了到达目标所经过的 AS 数量。

5.  **ORIGIN (起源)**:
    -   指明路由是如何进入 BGP 的。
    -   顺序：**IGP (i)** > **EGP (e)** > **Incomplete (?)**。IGP 起源（通过 `network` 命令注入）最优。

6.  **MED (Multi-Exit Discriminator)**:
    -   用于向一个**相邻的 AS** 指明进入本 AS 的**首选入口**。
    -   **值越低越优**。

---

### 13.4 基本的 eBGP 配置

假设 R1 (AS 65001) 和 R2 (AS 65002) 是两个 eBGP 邻居。

**在 R1 上配置**:
```bash
R1(config)# router bgp 65001
# 启动 BGP 进程，并指定本地 AS 号

# 配置 eBGP 邻居
R1(config-router)# neighbor 10.1.1.2 remote-as 65002
# "10.1.1.2" 是 R2 的 IP 地址，"65002" 是 R2 所在的 AS 号

# 通告本地网络到 BGP
R1(config-router)# network 192.168.1.0 mask 255.255.255.0
# 要使用 network 命令通告路由，该路由必须已经存在于本路由器的路由表中
```

**在 R2 上配置**:
```bash
R2(config)# router bgp 65002
R2(config-router)# neighbor 10.1.1.1 remote-as 65001
R2(config-router)# network 172.16.1.0 mask 255.255.255.0
```

**验证 BGP**:
```bash
# 查看 BGP 邻居状态
show ip bgp summary

# 查看 BGP 路由表
show ip bgp

# 查看从邻居收到的路由
show ip bgp neighbors <neighbor-ip> received-routes
```
`show ip bgp summary` 是最重要的验证命令。在 `State/PfxRcd` 这一列，如果看到的是一个数字（如 1），则表示邻居关系已成功建立（Established），并且已经从该邻居收到了 1 条路由前缀。如果状态不是 Established，则需要检查两端的配置（AS号、IP地址）和网络连通性。 