# 16. NAT (Network Address Translation)

网络地址转换（NAT）是一项在路由器上运行的技术，它通过修改 IP 数据包报头中的源或目的地址信息，实现了私有 IP 地址和公有 IP 地址之间的转换。NAT 最初是为了缓解 IPv4 地址耗尽问题而设计的，但它也带来了网络安全上的一些附带好处。

---

### 16.1 为什么需要 NAT？

在 RFC 1918 中定义了三段私有 IP 地址空间：
-   `10.0.0.0` - `10.255.255.255` (10.0.0.0/8)
-   `172.16.0.0` - `172.31.255.255` (172.16.0.0/12)
-   `192.168.0.0` - `192.168.255.255` (192.168.0.0/16)

这些私有地址可以在任何组织的内部网络中自由使用，但它们**不能在公共互联网上路由**。NAT 的主要作用就是让使用这些私有地址的内部设备，能够通过一个或多个合法的公有 IP 地址去访问互联网。

**主要优点**:
1.  **节省公有 IPv4 地址**: 一个机构可以拥有数千台使用私有地址的设备，但只需要一个或少数几个公有 IP 地址就可以让所有设备上网。
2.  **增强安全性**: NAT 隐藏了内部网络的结构。从外部看，所有流量都似乎来自执行 NAT 的路由器，外部设备无法直接发起连接到内部的某台具体主机，这形成了一道天然的屏障。

---

### 16.2 NAT 的类型

1.  **静态 NAT (Static NAT)**:
    -   建立一个私有 IP 地址和公有 IP 地址之间的**一对一**的、永久的映射关系。
    -   **用途**: 主要用于将内部的服务器（如 Web 服务器、邮件服务器）发布到互联网上，让外部用户可以访问。
    -   **缺点**: 每个需要发布的内部服务器都需要消耗一个宝贵的公有 IP 地址。

2.  **动态 NAT (Dynamic NAT)**:
    -   创建一个公有 IP 地址池。当内部主机需要访问互联网时，会从这个地址池中**临时租用**一个公有 IP 地址进行转换。当会话结束后，该公有 IP 地址会被释放，返回到地址池中供其他主机使用。
    -   它实现了**多对多**的映射，但映射的数量受限于地址池的大小。
    -   **缺点**: 如果所有地址池中的公有 IP 都被占用，后面的内部主机将无法访问互联网。它不节省地址，只是灵活分配。

3.  **PAT (Port Address Translation) 或 NAPT**
    -   也称为 **NAT 过载 (NAT Overload)**，这是**最常用**的一种 NAT 形式。
    -   PAT 将多个私有 IP 地址映射到**同一个公有 IP 地址**的不同**端口号**上。
    -   路由器维护着一张 NAT 转换表，表中记录了 `(源私有IP, 源端口)` 到 `(公有IP, 唯一外部端口)` 的映射关系。通过这种方式，一个公有 IP 地址可以同时支持数千个内部连接。
    -   **优点**: 极大地节省了公有 IP 地址，是家庭和绝大多数企业使用的上网方式。

---

### 16.3 NAT 的工作流程 (以 PAT 为例)

1.  内部主机 `192.168.1.10` 想要访问 Web 服务器 `8.8.8.8`。它发送一个数据包，源地址是 `192.168.1.10:12345` (IP:Port)，目的地址是 `8.8.8.8:80`。
2.  数据包到达 NAT 路由器。路由器看到源地址是私有地址，需要进行 NAT 转换。
3.  路由器将数据包的源地址修改为自己的公有 IP 地址，并分配一个唯一的源端口号。例如，修改为 `203.0.113.1:50001`。
4.  同时，路由器在自己的 NAT 转换表中创建一条记录：`内部: 192.168.1.10:12345 <--> 外部: 203.0.113.1:50001`。
5.  修改后的数据包被发送到互联网。
6.  Web 服务器 `8.8.8.8` 收到请求后，会回复一个数据包，目的地址是 `203.0.113.1:50001`。
7.  当这个回复包到达 NAT 路由器时，路由器查询 NAT 转换表，发现 `203.0.113.1:50001` 对应的是内部主机 `192.168.1.10:12345`。
8.  路由器将回复包的目的地址修改回 `192.168.1.10:12345`，并将其转发给内部主机。

整个过程对内部主机和外部服务器都是透明的。

---

### 16.4 在思科路由器上配置 PAT

假设 `GigabitEthernet0/0` 是连接互联网的外部接口，`GigabitEthernet0/1` 是连接内部局域网的接口。

```bash
Router(config)# interface GigabitEthernet0/0
Router(config-if)# description WAN_Interface
# 假设该接口已通过 DHCP 获取了公有 IP
Router(config-if)# ip address dhcp
# 定义为 NAT 外部接口
Router(config-if)# ip nat outside
Router(config-if)# exit

Router(config)# interface GigabitEthernet0/1
Router(config-if)# description LAN_Interface
Router(config-if)# ip address 192.168.1.1 255.255.255.0
# 定义为 NAT 内部接口
Router(config-if)# ip nat inside
Router(config-if)# exit

# 1. 定义一个访问控制列表 (ACL) 来匹配需要被 NAT 的内部私有地址流量
Router(config)# access-list 1 permit 192.168.1.0 0.0.0.255

# 2. 创建 NAT 规则
# 将 ACL 1 中匹配的流量，转换成 "GigabitEthernet0/0" 接口的 IP 地址，并启用 PAT (overload)
Router(config)# ip nat inside source list 1 interface GigabitEthernet0/0 overload
```
这三条命令就完成了一个最常见的 PAT 配置。

**验证 NAT**:
```bash
# 查看活动的 NAT 转换
show ip nat translations

# 查看 NAT 的统计信息
show ip nat statistics
``` 