# 7. HDFS (Hadoop Distributed File System)

HDFS（Hadoop Distributed File System）是Apache Hadoop项目的核心组件之一，是一个专为**大规模数据集**设计的、高容错、高吞吐量的分布式文件系统。它构成了整个Hadoop生态系统（包括MapReduce, Hive, HBase等）的数据存储基石。

HDFS的设计哲学是**"一次写入，多次读取" (Write-Once-Read-Many)**。它特别适合存储海量的、静态的、需要进行批量分析处理的大文件，而不适合需要低延迟随机写入的场景。

## HDFS 架构

HDFS采用主/从（Master/Slave）架构。

![HDFS Architecture](https://hadoop.apache.org/docs/r1.2.1/images/hdfsarchitecture.gif)
*(图片来源: Apache Hadoop Project)*

- **NameNode (名称节点) - Master**:
  - **角色**: HDFS集群的大脑。它**不存储实际的数据**，而是负责管理整个文件系统的**元数据 (Metadata)**。
  - **元数据包括**:
    - 文件系统的命名空间（目录树结构）。
    - 文件到数据块（Block）的映射关系。
    - 每个数据块存储在哪些DataNode上。
  - **职责**:
    - 维护文件系统树。
    - 响应客户端的元数据操作请求（如打开、关闭、重命名文件/目录）。
    - 决定数据块到DataNode的映射。
    - 接收来自DataNode的心跳和块报告。
  - **关键点**: NameNode是HDFS集群的**单点故障**。在现代Hadoop中，通常会部署一个Active NameNode和一个Standby NameNode来实现高可用性。

- **DataNode (数据节点) - Slave**:
  - **角色**: HDFS集群的劳工。负责**存储实际的数据块**。
  - **职责**:
    - 根据NameNode的指令存储、读取、删除数据块。
    - 定期向NameNode发送心跳，报告其健康状况。
    - 定期向NameNode发送块报告（Block Report），汇报自己持有的数据块列表。
  - **关键点**: DataNode通常部署在廉价的商用硬件上。HDFS通过数据冗余来应对DataNode的故障。

## 核心特性

### 1. 数据块 (Blocks)

- HDFS会将大文件切分成固定大小的数据块（Block）。一个Block的大小通常很大，例如128MB或256MB（远大于传统文件系统的4KB或8KB）。
- **大块的好处**:
  - **减少元数据开销**: NameNode只需要为每个块存储一份元数据，而不是为文件中的每个字节。块越大，元数据就越少，NameNode的内存压力就越小。
  - **优化数据传输**: 更适合磁盘的顺序读写，能够最大化磁盘的吞吐量。

### 2. 数据复制与副本放置策略

- **可靠性**: 为了实现容错，HDFS会将每个数据块复制多份（默认为**3个副本**）。
- **副本放置策略**: HDFS会智能地将这3个副本放置在不同的物理位置，以应对不同级别的故障：
  - **副本1**: 放置在客户端所在的节点上（如果客户端在集群内）。
  - **副本2**: 放置在与第一个副本**不同机架 (Rack)**的某个节点上。
  - **副本3**: 放置在与第二个副本**相同机架**，但**不同节点**上。
- **策略优势**:
  - 既保证了跨机架的容灾能力（即使整个机架掉电，数据仍然可用）。
  - 又优化了读写性能和网络带宽（一个副本在同机架内，写操作的流水线可以更快；读操作可以优先选择最近的副本）。

### 3. 文件读写流程

- **写文件**:
  1.  客户端向NameNode请求写入文件，NameNode检查权限并返回存储该文件第一个块的DataNode列表（例如，3个DataNode的地址）。
  2.  客户端直接与第一个DataNode通信，并开始传输数据。
  3.  这个DataNode接收到数据后，会将其写入本地，并同时将数据**流水线式 (Pipelining)**地传输给列表中的第二个DataNode。
  4.  第二个DataNode再同样地传输给第三个。
  5.  当所有3个副本都写入成功后，确认信息会沿着流水线反向传回客户端。
  6.  客户端继续向NameNode请求下一个块的存储位置，重复此过程直到文件写完。

- **读文件**:
  1.  客户端向NameNode请求读取文件。
  2.  NameNode返回该文件所有数据块的位置列表（对于每个块，都包含持有其副本的多个DataNode地址）。
  3.  客户端直接联系距离自己**最近**的DataNode来读取数据块，并按顺序组装成完整的文件。

## HDFS的优缺点

### 优点

- **高容错性**: 通过多副本机制，可以容忍多个节点故障。
- **高吞吐量**: 专为大文件的顺序读写优化，非常适合批量数据处理。
- **线性扩展**: 可以通过简单地增加DataNode来平滑地扩展存储容量和处理能力。
- **生态系统成熟**: 作为Hadoop生态的核心，与MapReduce, Spark, Hive, HBase等大数据工具无缝集成。

### 缺点

- **不适合低延迟访问**: 设计目标是高吞吐量，而不是低延迟。不适合需要毫秒级响应的随机读写场景。
- **不适合小文件存储**: 存储大量小文件会给NameNode带来巨大的元数据内存压力，并且每个小文件都会占用一个完整的块空间，导致存储效率低下。
- **不适合频繁写入**: "一次写入，多次读取"的模型意味着它不支持文件的任意修改。文件只能在末尾追加内容，而不能在中间修改。
- **单点故障**: 尽管有HA方案，NameNode仍然是整个架构中最关键和最复杂的点。

HDFS是大数据时代的一个里程碑，它证明了可以用廉价硬件构建出可靠、可扩展的海量数据存储系统，其设计思想影响了后续许多分布式文件系统。 