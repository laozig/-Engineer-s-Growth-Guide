# 13. etcd

`etcd` 是一个开源的、分布式的、强一致性的键值存储系统。它由CoreOS团队开发，现在是云原生计算基金会（CNCF）的毕业项目。`etcd`在云原生生态系统中扮演着至关重要的角色，最著名的应用就是作为**Kubernetes**集群的后端存储，负责存储所有集群的状态数据。

`etcd`的设计目标**不是**作为一个通用的、大规模的数据库（像TiKV或Cassandra），而是作为一个高度可靠的**协调服务 (Coordination Service)**。

## `etcd` 架构与核心原理

`etcd`的架构非常简洁，其核心完全建立在**Raft共识算法**之上。

- **Raft集群**:
  - `etcd`服务通常以一个小的集群（推荐3、5或7个节点）形式部署，以保证高可用性。
  - 集群中的所有节点通过Raft协议来选举一个Leader，并保证所有节点上的数据副本是强一致的。
- **强Leader模型**:
  - 所有**写**请求都必须由Leader处理。
  - **读**请求默认也由Leader处理，以保证线性一致性（即读到最新的已提交数据）。也可以配置为从Follower读，以提高读吞吐量，但会牺牲一致性（可能读到稍微滞后的数据）。
- **数据存储**:
  - `etcd`将键值数据存储在本地磁盘上，使用一个B+树的变种来索引数据。
  - 它同时维护一个预写日志（WAL, Write-Ahead Log），所有的数据变更在应用到存储前都会先写入WAL，这是Raft协议的要求，用于保证节点崩溃后能恢复状态。

![etcd Raft](https://etcd.io/docs/v3.5/learning/images/raft.gif)
*(图片来源: etcd.io)*

## `etcd` 的核心API与应用模式

`etcd`提供的API非常精炼，但足以支撑起复杂的协调任务。

### 1. 键值操作 (Get/Put/Delete)

这是`etcd`最基本的功能，允许客户端存储、读取和删除键值对。

- **事务 (Transactions)**:
  `etcd`支持多键的原子事务。它提供了一种`If-Then-Else`结构的事务API，允许你"比较"一个或多个键的值，如果满足条件，则执行一系列操作（Then），否则执行另一系列操作（Else）。
  - **应用**: 这对于实现**分布式锁**或**原子性地更新多个相关状态**至关重要。例如，在Kubernetes中，创建一个Pod的操作可能需要原子性地更新多个相关的元数据。

### 2. 监听 (Watch)

`Watch`是`etcd`最强大和最具特色的功能。客户端可以"监听"一个键或一个键范围（前缀）的变化。
- **工作原理**: 当被监听的键发生任何变化（创建、更新、删除）时，`etcd`会立即向客户端发送一个通知事件。
- **应用**: 这是实现**发布-订阅 (Pub/Sub)**模式和**响应式系统**的基础。
  - 在Kubernetes中，几乎所有的控制器（Controller）都在`Watch` API上工作。例如，Deployment控制器会监听Deployment对象的变化。当用户创建一个新的Deployment时，控制器会收到通知，然后执行相应的动作（如创建ReplicaSet）。当Pod的状态发生变化时，Deployment控制器也会收到通知，并据此决定是否需要创建新的Pod。

### 3. 租约 (Lease)

`Lease`是一种与键关联的、具有超时时间的机制。
- **工作原理**:
  1.  客户端创建一个`Lease`，并指定一个存活时间（TTL, Time-To-Live）。
  2.  客户端可以将一个或多个键与这个`Lease`关联。
  3.  客户端必须在`Lease`过期前，通过"续约 (Keep-Alive)"操作来刷新它的TTL。
  4.  如果客户端未能及时续约（例如客户端崩溃或网络中断），`Lease`就会过期，**所有与该`Lease`关联的键都会被`etcd`自动删除**。
- **应用**: `Lease`是实现**服务发现 (Service Discovery)**和**临时节点 (Ephemeral Node)**的完美机制。
  - 一个服务实例在启动时，可以在`etcd`中创建一个键（如`/services/my-service/instance-1`），并将其与一个`Lease`关联。只要该服务实例存活，它就会不断地为`Lease`续约。如果服务崩溃，`Lease`过期，它在`etcd`中对应的键就会被自动清理。其他服务可以通过`Watch` `/services/my-service/`前缀来实时地感知服务实例的上线和下线。

## `etcd` 的适用场景

- **服务发现与配置共享**: 作为所有微服务的"真理之源 (Source of Truth)"，存储服务的地址、配置信息等。
- **分布式协调**:
  - **分布式锁**: 利用事务API实现集群范围内的互斥锁。
  - **领导者选举**: 多个实例可以尝试创建一个与Lease关联的键，成功者成为Leader。
- **状态存储**: 存储分布式系统的状态，并通过Watch机制驱动系统的状态变更，如Kubernetes。

## `etcd` 不适合做什么

- **大规模数据存储**: `etcd`为可靠性和一致性而设计，不是为性能和容量。将大量数据（如TB级别）存入`etcd`会严重影响其性能和稳定性。
- **高频读写**: 不适合用作应用的缓存或主数据库。
- **存储大Value**: 单个键值对的大小有限制（通常为1.5MB）。

## 总结

`etcd`是一个小而美的、专注于分布式协调的工具。它通过对Raft协议的坚实实现，提供了强一致性的键值存储，并通过独特的Watch和Lease机制，为构建复杂的、可靠的云原生分布式系统提供了一套优雅而强大的"积木"。理解`etcd`，是理解整个Kubernetes乃至云原生系统工作原理的钥匙。 