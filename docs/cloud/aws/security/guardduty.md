# AWS GuardDuty 威胁检测

Amazon GuardDuty 是一项持续安全监控和威胁检测服务，通过分析和处理多种数据源，识别 AWS 环境中的异常行为和潜在安全威胁。本文档详细介绍 GuardDuty 的原理、功能、配置方法、运维与最佳实践。

## 目录

- [服务简介](#服务简介)
- [工作原理](#工作原理)
- [数据源与检测范围](#数据源与检测范围)
- [发现类型](#发现类型)
- [配置与启用](#配置与启用)
- [多账户管理](#多账户管理)
- [自定义威胁检测](#自定义威胁检测)
- [与其他 AWS 服务集成](#与其他-aws-服务集成)
- [监控与告警](#监控与告警)
- [响应与修复](#响应与修复)
- [成本管理](#成本管理)
- [最佳实践](#最佳实践)
- [常见问题排查](#常见问题排查)
- [参考资源](#参考资源)

## 服务简介

Amazon GuardDuty 是一项智能威胁检测服务，持续监控 AWS 账户和工作负载，识别可疑活动和潜在安全威胁。主要特点：

- 无需部署额外代理或安全基础设施
- 基于机器学习、异常检测和威胁情报
- 自动分析多种 AWS 日志和事件数据
- 提供详细的安全发现结果和建议
- 与其他 AWS 安全服务无缝集成

## 工作原理

GuardDuty 通过以下步骤提供威胁检测：

1. **数据收集**：自动收集和处理 AWS CloudTrail 事件日志、VPC 流日志、DNS 日志等
2. **威胁分析**：应用机器学习模型、异常检测算法和威胁情报源
3. **发现生成**：识别可疑活动并生成详细的安全发现结果
4. **严重性分类**：按高、中、低严重性级别对发现进行分类
5. **通知与集成**：通过 CloudWatch Events 发送通知，支持自动响应

## 数据源与检测范围

### 核心数据源

- **AWS CloudTrail 管理事件**：监控 API 调用和管理操作
- **AWS CloudTrail S3 数据事件**：监控 S3 对象级操作
- **VPC 流日志**：分析网络流量和通信模式
- **DNS 日志**：检测可疑域名请求和 DNS 隧道
- **Kubernetes 审计日志**：监控 EKS 集群活动

### 可选数据源

- **EKS 审计日志**：深入分析 Kubernetes 集群中的活动
- **RDS 登录活动监控**：检测数据库访问异常
- **EBS 卷扫描**：检测 EC2 实例中的恶意软件
- **Lambda 网络活动监控**：分析 Lambda 函数的网络行为
- **S3 恶意软件防护**：扫描 S3 对象中的恶意软件

## 发现类型

GuardDuty 可以检测多种类型的威胁，包括：

### 恶意软件与勒索软件

- EC2 实例和容器中的恶意软件
- 加密挖矿活动
- 勒索软件行为模式

### 账户入侵

- 凭证泄露和滥用
- 异常登录行为
- 权限提升尝试
- 未授权的 API 调用

### 数据渗漏

- 可疑数据传输
- 未授权的数据访问
- S3 存储桶异常行为

### 网络威胁

- 恶意 IP 地址通信
- 可疑端口扫描
- 异常出站流量
- DNS 数据渗漏

### Kubernetes 威胁

- 容器逃逸尝试
- 可疑的 Pod 行为
- 权限滥用

## 配置与启用

### 启用 GuardDuty

1. 登录 AWS Management Console
2. 导航至 GuardDuty 服务
3. 选择"开始使用"或"启用 GuardDuty"
4. 选择要启用的数据源（建议启用所有可用数据源）
5. 确认设置并完成启用

### 配置数据源

- **S3 保护**：启用 S3 数据事件监控
- **恶意软件防护**：配置 EC2 实例和 EBS 卷扫描
- **RDS 保护**：启用数据库活动监控
- **EKS 保护**：配置 Kubernetes 审计日志监控
- **Lambda 保护**：启用 Lambda 函数网络活动监控

### 配置发现结果

- 设置发现结果通知频率
- 配置抑制规则（用于忽略特定类型的发现）
- 设置可信 IP 列表和威胁列表

## 多账户管理

### 组织集成

- 通过 AWS Organizations 在多个账户中启用 GuardDuty
- 指定管理员账户集中管理发现结果
- 自动将新账户添加到 GuardDuty 监控范围

### 委派管理

1. 在组织管理账户中，导航到 GuardDuty
2. 选择"账户"，然后选择"指定委派管理员"
3. 输入要作为 GuardDuty 管理员的账户 ID
4. 在管理员账户中，为成员账户启用 GuardDuty

### 成员账户管理

- 集中查看所有成员账户的发现结果
- 为成员账户配置数据源和设置
- 管理成员账户的抑制规则和可信 IP 列表

## 自定义威胁检测

### 可信 IP 列表

- 创建包含已知安全 IP 地址的列表
- GuardDuty 不会为这些 IP 生成发现结果
- 适用于企业 IP 范围或可信合作伙伴

### 威胁列表

- 创建自定义恶意 IP 地址列表
- 与这些 IP 的任何通信都会生成高严重性发现结果
- 适用于行业特定威胁或内部已知威胁

### 抑制规则

- 创建规则以自动归档特定发现结果
- 基于属性（如资源标签、IP 地址、账户 ID）
- 减少误报和不相关的发现结果

## 与其他 AWS 服务集成

### Security Hub 集成

- 将 GuardDuty 发现结果发送到 Security Hub
- 在单一控制台中查看综合安全状态
- 与安全标准和合规性检查结合

### Detective 集成

- 深入调查 GuardDuty 发现结果
- 分析资源行为和关系图
- 确定攻击范围和影响

### EventBridge 集成

- 自动响应 GuardDuty 发现结果
- 触发修复工作流程
- 发送通知到 Slack、电子邮件等

### Systems Manager 集成

- 自动修复受感染的 EC2 实例
- 隔离受损资源
- 运行安全强化脚本

## 监控与告警

### CloudWatch 告警

- 为高严重性发现结果创建告警
- 监控特定类型的威胁活动
- 设置告警阈值和操作

### 发现结果通知

- 配置 SNS 通知
- 设置 Lambda 函数处理发现结果
- 集成 SIEM 系统和安全工具

### 控制面板与报告

- 使用 CloudWatch 控制面板可视化安全状态
- 创建定期安全报告
- 跟踪威胁趋势和模式

## 响应与修复

### 发现结果分类

- 评估发现结果的严重性和影响
- 确定是否为误报或真实威胁
- 优先处理高风险发现结果

### 自动响应

- 使用 EventBridge 规则触发自动响应
- 隔离受感染资源
- 撤销可疑 IAM 凭证
- 阻止可疑网络流量

### 手动调查

- 使用 Detective 进行深入调查
- 分析资源历史行为
- 确定攻击路径和范围

### 修复步骤

- 移除恶意软件
- 更新受损凭证
- 修补漏洞
- 更新安全组和网络 ACL
- 强化安全配置

## 成本管理

- 基于分析的数据量计费
- 按账户和区域单独计费
- 30 天免费试用
- 优化数据源配置控制成本

## 最佳实践

### 部署建议

- 在所有账户和区域中启用 GuardDuty
- 启用所有数据源获得全面保护
- 使用委派管理员集中管理多账户环境
- 为新账户自动启用 GuardDuty

### 运营最佳实践

- 定期审查发现结果
- 维护可信 IP 列表和威胁列表
- 创建适当的抑制规则减少噪音
- 实施自动响应流程
- 与 Security Hub 和 Detective 集成

### 安全团队工作流程

- 建立发现结果分类和响应流程
- 定义严重性级别和响应时间目标
- 创建安全事件上报流程
- 定期进行安全演练测试响应能力

## 常见问题排查

- 发现结果延迟或缺失
- 误报处理策略
- 多账户设置问题
- 数据源配置错误
- 自动响应失败

## 参考资源

- [AWS GuardDuty 官方文档](https://docs.aws.amazon.com/guardduty/)
- [GuardDuty 发现结果类型](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html)
- [GuardDuty 安全最佳实践](https://aws.amazon.com/cn/blogs/security/top-10-security-best-practices-for-securing-data-in-amazon-guardduty/)
- [自动响应 GuardDuty 发现结果](https://aws.amazon.com/cn/blogs/security/automated-response-and-remediation-with-aws-security-hub/)
- [GuardDuty 定价](https://aws.amazon.com/cn/guardduty/pricing/) 