# AWS CloudTrail 审计

AWS CloudTrail 是一项记录和监控 AWS 账户活动的服务，提供 API 调用历史记录，帮助用户实现合规性、操作审计和风险分析。本文档详细介绍 CloudTrail 的核心功能、配置方法、安全性与最佳实践。

## 目录

- [服务简介](#服务简介)
- [核心概念](#核心概念)
- [事件类型](#事件类型)
- [跟踪配置](#跟踪配置)
- [日志文件与存储](#日志文件与存储)
- [事件历史记录](#事件历史记录)
- [洞察事件](#洞察事件)
- [安全与合规](#安全与合规)
- [与其他服务集成](#与其他服务集成)
- [多账户和多区域](#多账户和多区域)
- [监控与告警](#监控与告警)
- [最佳实践](#最佳实践)
- [常见问题排查](#常见问题排查)
- [参考资源](#参考资源)

## 服务简介

AWS CloudTrail 是一项 AWS 服务，可帮助用户对 AWS 账户进行治理、合规性监控和操作风险审计。主要特点：

- 记录 AWS 账户中的 API 调用和相关事件
- 提供 AWS 资源变更的详细历史记录
- 支持安全分析、资源变更跟踪和合规性审计
- 自动将日志文件传送到 Amazon S3 存储桶
- 与多种 AWS 服务集成，实现自动化分析和响应

## 核心概念

### 跟踪（Trail）

- CloudTrail 的核心配置单元，定义如何收集和存储事件
- 可应用于单个区域或所有区域
- 可配置为记录读取、写入或所有 API 活动
- 支持将日志传送到 S3、CloudWatch Logs 和 EventBridge

### 事件（Event）

- 代表 AWS 环境中的活动记录
- 包含操作者身份、时间、源 IP、请求参数等信息
- 以 JSON 格式存储，便于分析和处理
- 按类型分为管理事件、数据事件和洞察事件

### 事件历史记录（Event History）

- 过去 90 天的管理事件的可搜索、可筛选视图
- 通过 CloudTrail 控制台、API 或 CLI 访问
- 支持按时间范围、事件名称、资源和用户筛选
- 无需配置跟踪即可使用

## 事件类型

### 管理事件

- 也称为控制平面操作
- 在 AWS 资源上执行的管理操作（如创建/删除资源）
- 包括安全配置（IAM AttachRolePolicy）
- 设置路由规则、网络设置等
- 默认情况下在跟踪中启用

### 数据事件

- 也称为数据平面操作
- 资源上或资源内执行的数据操作（如 S3 对象操作）
- 包括 S3 对象级 API、Lambda 函数执行、DynamoDB 项目操作等
- 高容量事件，默认不启用
- 可按资源类型和特定资源配置

### 洞察事件

- 记录账户中异常的 API 调用活动
- 分析管理 API 调用量的异常模式
- 帮助识别异常活动、未授权访问和性能问题
- 需要额外配置和费用

## 跟踪配置

### 创建跟踪

1. 登录 AWS Management Console
2. 导航至 CloudTrail 服务
3. 选择"创建跟踪"
4. 配置跟踪名称和存储位置
5. 选择事件类型和管理选项
6. 配置高级设置（如日志文件验证、SNS 通知）
7. 完成创建

### 跟踪设置选项

- **跟踪名称**：唯一标识符
- **存储位置**：S3 存储桶和前缀
- **日志文件 SSE-KMS 加密**：增强安全性
- **日志文件验证**：确保完整性
- **SNS 通知**：日志文件传送通知
- **CloudWatch Logs**：实时监控和告警
- **标签**：资源组织和成本分配

### 高级配置

- **多区域跟踪**：记录所有 AWS 区域的事件
- **组织跟踪**：记录 AWS Organizations 中所有账户的事件
- **数据事件**：配置特定资源类型的数据操作记录
- **洞察事件**：启用异常活动检测
- **日志保留**：配置日志保留策略

## 日志文件与存储

### 日志文件格式

- JSON 格式，便于机器处理和分析
- 包含事件时间、用户身份、事件源、请求参数等
- 按时间顺序组织，通常每 5 分钟生成一次
- 可能会因活动量而合并或分割

### 存储选项

- **S3 存储桶**：默认存储位置，支持生命周期策略
- **S3 Glacier**：长期归档存储，降低成本
- **CloudWatch Logs**：实时处理和告警
- **Lake Formation**：集中式数据湖分析

### 日志文件安全

- **SSE-S3/SSE-KMS 加密**：静态数据加密
- **日志文件完整性验证**：防止未经授权的修改
- **S3 存储桶策略**：控制访问权限
- **日志文件压缩**：减少存储空间

## 事件历史记录

- 提供过去 90 天的管理事件记录
- 无需配置跟踪即可访问
- 支持按多种属性筛选和搜索
- 可下载为 CSV 或 JSON 格式
- 提供事件详细信息，包括请求和响应元素

## 洞察事件

### 洞察类型

- **API 调用率洞察**：检测 API 调用量的异常变化
- **API 错误率洞察**：检测 API 错误的异常增加
- **基于机器学习的异常检测**：识别异常模式

### 配置洞察

1. 创建或编辑跟踪
2. 启用 CloudTrail Insights
3. 选择要监控的洞察类型
4. 配置基准期和告警

### 洞察分析

- 识别潜在的安全问题（如凭证泄露）
- 检测配置错误和性能问题
- 提供异常活动的详细上下文
- 支持与 Security Hub 和 EventBridge 集成

## 安全与合规

### 日志文件安全

- 使用 IAM 策略控制对 CloudTrail 的访问
- 实施 S3 存储桶策略限制日志访问
- 启用日志文件验证确保完整性
- 使用 KMS 加密增强数据保护

### 合规性支持

- 支持多种合规性标准（如 PCI DSS、HIPAA、SOC）
- 提供不可变的审计记录
- 帮助满足行业监管要求
- 支持取证调查和安全分析

### 防篡改机制

- 日志文件验证使用数字签名
- 检测日志文件删除、修改或伪造
- 提供验证工具验证日志完整性
- 支持不可变的 S3 对象锁定

## 与其他服务集成

### 安全服务集成

- **GuardDuty**：威胁检测和安全分析
- **Security Hub**：安全状态管理和合规性检查
- **Macie**：敏感数据发现和保护
- **Detective**：安全调查和根本原因分析

### 分析服务集成

- **Athena**：使用 SQL 查询日志文件
- **CloudWatch Logs**：实时日志分析和告警
- **QuickSight**：创建可视化仪表板
- **Lake Formation**：集中式数据湖管理

### 自动化集成

- **EventBridge**：基于 CloudTrail 事件触发自动化
- **Lambda**：自动响应特定事件
- **Step Functions**：编排复杂的响应工作流程
- **SNS**：事件通知和告警

## 多账户和多区域

### 组织跟踪

- 在 AWS Organizations 中为所有成员账户创建跟踪
- 集中管理和存储所有账户的日志
- 简化合规性和安全管理
- 支持委派管理

### 多区域配置

- 创建记录所有区域活动的跟踪
- 自动包含新区域
- 集中存储所有区域的日志
- 全球安全态势管理

### 聚合分析

- 使用 Athena 跨账户和区域分析日志
- 创建集中式安全控制面板
- 实施统一的安全策略
- 简化合规性报告

## 监控与告警

### CloudWatch 集成

- 将 CloudTrail 事件发送到 CloudWatch Logs
- 创建指标筛选器监控特定活动
- 设置基于模式的告警
- 实时响应安全事件

### 告警场景

- 安全组和网络 ACL 更改
- IAM 策略修改
- 根用户活动
- 授权失败
- 控制台登录失败

### 自动响应

- 使用 EventBridge 规则检测特定事件
- 触发 Lambda 函数进行自动修复
- 发送通知到安全团队
- 集成 SIEM 系统进行高级分析

## 最佳实践

### 配置建议

- 为所有区域创建至少一个跟踪
- 启用日志文件验证
- 使用 SSE-KMS 加密日志文件
- 实施 S3 生命周期策略管理存储成本
- 考虑启用 CloudTrail Insights

### 安全最佳实践

- 限制对 CloudTrail 配置的访问
- 保护 S3 存储桶中的日志文件
- 监控 CloudTrail 日志的交付
- 定期验证日志文件完整性
- 使用 CloudTrail 处理库验证日志

### 成本优化

- 选择性启用数据事件
- 实施 S3 生命周期策略
- 使用 S3 Glacier 进行长期存储
- 优化 CloudWatch Logs 保留期
- 考虑 Insights 事件的选择性使用

### 日志分析策略

- 创建常用查询和报告
- 实施自动化安全检查
- 定期审查异常活动
- 建立基线和异常检测
- 集成 SIEM 工具进行高级分析

## 常见问题排查

- 日志文件未传送到 S3
- 特定 API 调用未记录
- 日志文件验证失败
- 多账户日志聚合问题
- CloudWatch 集成配置错误

## 参考资源

- [CloudTrail 官方文档](https://docs.aws.amazon.com/cloudtrail/)
- [CloudTrail 日志文件参考](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference.html)
- [CloudTrail 安全最佳实践](https://aws.amazon.com/blogs/mt/aws-cloudtrail-security-best-practices/)
- [使用 Athena 分析 CloudTrail 日志](https://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html)
- [CloudTrail 定价](https://aws.amazon.com/cloudtrail/pricing/)
