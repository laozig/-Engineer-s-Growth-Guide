# AWS CloudWatch 监控

Amazon CloudWatch 是 AWS 的监控和可观测性服务，提供数据和可操作的洞察，帮助用户监控应用程序、响应系统范围的性能变化、优化资源利用率，并获得运行状况的统一视图。本文档详细介绍 CloudWatch 的核心功能、配置方法、运维与最佳实践。

## 目录

- [服务简介](#服务简介)
- [核心组件](#核心组件)
- [指标监控](#指标监控)
- [日志管理](#日志管理)
- [告警系统](#告警系统)
- [事件与EventBridge](#事件与eventbridge)
- [应用洞察](#应用洞察)
- [合成监控](#合成监控)
- [容器洞察](#容器洞察)
- [Lambda洞察](#lambda洞察)
- [跨账户观测性](#跨账户观测性)
- [控制面板与可视化](#控制面板与可视化)
- [与其他服务集成](#与其他服务集成)
- [最佳实践](#最佳实践)
- [常见问题排查](#常见问题排查)
- [参考资源](#参考资源)

## 服务简介

Amazon CloudWatch 是一项全面的监控和可观测性服务，具有以下主要特点：

- 收集和跟踪指标、日志和事件
- 实时监控 AWS 资源和应用程序
- 设置警报和自动响应变化
- 提供统一的可观测性平台
- 支持自定义指标和日志分析
- 与其他 AWS 服务深度集成

## 核心组件

CloudWatch 由以下核心组件组成：

- **指标（Metrics）**：时间序列数据点，用于监控资源和应用程序性能
- **日志（Logs）**：集中存储和分析日志文件
- **告警（Alarms）**：监控指标并在超过阈值时触发操作
- **事件（Events）**：近乎实时地响应 AWS 资源的状态变化
- **控制面板（Dashboards）**：自定义视图，显示资源和应用程序的指标和告警

## 指标监控

### 基本概念

- **命名空间（Namespace）**：指标的容器，通常按服务组织（如 AWS/EC2）
- **维度（Dimension）**：指标的标识属性（如 InstanceId）
- **统计数据（Statistics）**：指标数据的聚合（如 Average、Sum、Maximum）
- **周期（Period）**：聚合统计数据的时间长度（如 1 分钟、5 分钟）
- **分辨率（Resolution）**：标准分辨率（60 秒）和高分辨率（1 秒）

### AWS 服务指标

CloudWatch 自动收集许多 AWS 服务的指标，包括：

- **EC2**：CPU 利用率、网络流量、磁盘活动
- **RDS**：数据库连接、CPU 利用率、可用存储空间
- **S3**：存储桶大小、请求数、延迟
- **Lambda**：调用次数、持续时间、错误率
- **ELB**：请求计数、延迟、健康主机计数

### 自定义指标

- 使用 CloudWatch API 或 SDK 发布自定义指标
- 使用 CloudWatch 代理收集系统级指标和自定义应用程序指标
- 支持高分辨率指标（最高 1 秒粒度）
- 可设置维度以不同方式切片和分析数据

### 指标数学

- 对指标执行数学表达式和函数
- 创建新的时间序列数据
- 支持基本算术、统计函数和高级函数
- 用于趋势分析、异常检测和资源优化

## 日志管理

### 日志组和日志流

- **日志组（Log Group）**：日志的集合，通常按应用程序或服务类型组织
- **日志流（Log Stream）**：日志组中的序列，通常代表特定的实例或进程
- **保留策略**：自定义日志保留期（1 天至永不过期）
- **加密选项**：使用 KMS 密钥加密日志数据

### 日志收集方法

- **CloudWatch 代理**：从 EC2 实例和本地服务器收集日志
- **AWS 服务集成**：许多 AWS 服务直接发送日志到 CloudWatch
- **API 和 SDK**：使用 PutLogEvents API 直接发送日志
- **容器日志**：从 ECS 和 EKS 收集容器日志

### 日志洞察

- **CloudWatch Logs Insights**：交互式查询和分析日志数据
- **查询语言**：专用查询语言，用于过滤、排序和聚合日志数据
- **可视化**：查询结果的图形化表示
- **保存查询**：保存和重用常用查询

### 日志订阅

- **实时处理**：将日志数据实时流式传输到其他服务
- **订阅筛选器**：定义要处理的日志事件
- **目标服务**：Lambda、Kinesis Data Streams、Kinesis Data Firehose
- **跨账户日志订阅**：将日志数据发送到其他 AWS 账户

## 告警系统

### 告警基础

- **指标告警**：基于 CloudWatch 指标的阈值监控
- **复合告警**：使用规则表达式组合多个告警状态
- **告警状态**：OK、ALARM、INSUFFICIENT_DATA
- **评估周期**：连续数据点数量和周期长度

### 告警操作

- **SNS 通知**：发送电子邮件、短信或其他通知
- **Auto Scaling 操作**：调整 EC2 实例数量
- **EC2 操作**：停止、终止、重启或恢复实例
- **Systems Manager 操作**：执行 SSM 自动化文档
- **Lambda 函数**：触发自定义 Lambda 函数

### 告警类型

- **静态阈值告警**：基于固定阈值
- **异常检测告警**：基于机器学习的动态阈值
- **指标数学告警**：基于指标数学表达式
- **复合告警**：基于多个告警的逻辑组合

### 高级告警功能

- **M of N 告警**：在 N 个数据点中有 M 个违反阈值时触发
- **等待期**：在触发告警前等待一段时间
- **缺失数据处理**：配置如何处理缺失数据点
- **告警预览**：在创建告警前预览其行为

## 事件与EventBridge

### CloudWatch Events

- 近乎实时地检测和响应 AWS 资源的状态变化
- 基于规则路由事件到目标服务
- 支持定时事件（类似 cron 表达式）
- 已演变为 Amazon EventBridge

### Amazon EventBridge

- CloudWatch Events 的扩展版本
- 支持 AWS 服务、自定义应用程序和 SaaS 应用程序之间的事件路由
- 提供事件总线，用于接收和路由事件
- 支持事件模式匹配和内容过滤
- 集成多种目标服务（Lambda、SNS、SQS 等）

## 应用洞察

### CloudWatch Application Insights

- 自动监控应用程序资源和技术堆栈
- 检测和关联异常和错误
- 创建控制面板和告警
- 支持 .NET 和 SQL Server 工作负载
- 提供问题的根本原因分析

### 服务地图

- 可视化服务依赖关系
- 跟踪请求流经应用程序组件
- 识别性能瓶颈和错误
- 与 X-Ray 集成

## 合成监控

### CloudWatch Synthetics

- 创建可编程的合成监控器（canary）
- 模拟用户行为和 API 调用
- 监控端点、API 和网站可用性
- 检测性能问题和中断
- 支持自定义脚本和预构建蓝图

### 蓝图类型

- **心跳监控器**：检查端点可用性
- **API 监控器**：验证 API 功能
- **UI 流程**：测试多步骤用户旅程
- **视觉监控**：捕获和比较屏幕截图

## 容器洞察

### CloudWatch Container Insights

- 监控、排查和告警容器化应用程序和微服务
- 支持 Amazon ECS、EKS、Kubernetes on EC2
- 收集、聚合和汇总指标和日志
- 提供容器级到集群级的性能视图
- 自动仪表板和诊断信息

### 收集的指标

- CPU、内存、磁盘和网络使用情况
- 容器重启失败
- 保留和挂起任务
- 集群、节点和服务级别指标

## Lambda洞察

### CloudWatch Lambda Insights

- Lambda 函数的监控和故障排除解决方案
- 收集、聚合和汇总系统级指标
- 提供函数性能的统一视图
- 自动仪表板显示内存、CPU 和其他指标
- 帮助识别和解决 Lambda 函数问题

### 关键指标

- 冷启动时间
- 内存使用率
- CPU 使用率
- 网络使用率
- 初始化时间和调用持续时间

## 跨账户观测性

### CloudWatch 跨账户观测性

- 在多个 AWS 账户之间共享 CloudWatch 数据
- 集中监控和故障排除
- 创建跨账户控制面板
- 设置跨账户告警
- 支持组织和监控账户模型

### 设置步骤

- 指定监控账户
- 配置源账户共享数据
- 设置所需的 IAM 权限
- 在监控账户中创建跨账户控制面板和告警

## 控制面板与可视化

### 自定义控制面板

- 创建可视化监控视图
- 添加多种小部件类型（图表、数字、文本等）
- 支持自动刷新和不同时间范围
- 共享控制面板和权限管理

### 小部件类型

- **线图**：显示一段时间内的指标变化
- **堆叠面积图**：显示多个相关指标
- **数字**：显示单个指标的当前值
- **量规**：显示相对于阈值的指标值
- **文本**：添加说明和上下文信息

### 实时数据

- 查看接近实时的指标数据
- 支持 1 秒刷新率
- 自定义时间范围和周期
- 快速识别和响应问题

## 与其他服务集成

### AWS 服务集成

- **X-Ray**：分布式跟踪和服务地图
- **ServiceLens**：将跟踪、指标、日志和告警结合在一起
- **CloudTrail**：记录和监控 API 调用
- **Config**：资源配置和合规性监控
- **Systems Manager**：操作洞察和自动化

### 第三方集成

- Grafana 数据源
- Prometheus 兼容 API
- 开源工具（如 collectd、statsd）
- 日志分析工具（如 ELK 堆栈）

## 最佳实践

### 监控策略

- 定义关键性能指标 (KPI)
- 实施多层监控（基础设施、应用程序、业务）
- 建立基准和阈值
- 实施自动化响应
- 定期审查和优化监控配置

### 告警优化

- 避免告警疲劳
- 使用复合告警减少噪音
- 实施升级流程
- 定期审查和调整阈值
- 使用异常检测处理动态工作负载

### 日志管理

- 定义日志保留策略
- 实施结构化日志记录
- 使用日志洞察进行主动分析
- 设置关键字告警
- 考虑日志聚合和中心化

### 成本优化

- 监控和优化指标和日志使用量
- 使用适当的分辨率（标准或高分辨率）
- 优化日志保留期
- 考虑日志筛选和采样
- 使用成本分配标签

## 常见问题排查

- 缺失指标数据
- 告警未触发或错误触发
- 日志延迟或丢失
- 代理配置问题
- 权限和访问控制问题

## 参考资源

- [CloudWatch 官方文档](https://docs.aws.amazon.com/cloudwatch/)
- [CloudWatch 指标参考](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CW_Support_For_AWS.html)
- [CloudWatch Logs Insights 查询语法](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)
- [CloudWatch 告警最佳实践](https://aws.amazon.com/blogs/mt/best-practices-for-monitoring-your-aws-environment/)
- [CloudWatch 定价](https://aws.amazon.com/cloudwatch/pricing/) 