# AWS Organizations 多账户管理

## 简介
AWS Organizations 是一项账户管理服务，使您能够将多个 AWS 账户整合到一个由您创建和集中管理的组织中。Organizations 提供账户管理和整合计费功能，使您能够更好地满足企业的预算、安全性和合规性需求。

## 核心概念

### 组织 (Organization)
- **定义**：由一个管理账户和零个或多个成员账户组成的实体
- **组织单位 (OU)**：账户的逻辑分组，可以嵌套形成层次结构
- **根 (Root)**：组织层次结构的起点，包含所有账户和 OU

### 账户类型
- **管理账户 (Management Account)**：
  - 创建组织的账户
  - 负责支付所有成员账户的费用
  - 拥有组织管理的特权权限
  - 不能更改或离开组织
  
- **成员账户 (Member Account)**：
  - 属于组织的其他 AWS 账户
  - 可以通过创建、邀请或迁移方式添加
  - 只能属于一个组织
  - 可以从组织中移除

### 服务控制策略 (SCP)
- **定义**：定义组织中账户可用的最大权限的策略文档
- **应用范围**：可应用于组织、OU 或单个账户
- **继承机制**：策略沿组织层次结构向下继承和累积
- **限制**：不影响管理账户，不授予权限（仅限制）

### 委派管理员 (Delegated Administrator)
- **定义**：被指定管理特定 AWS 服务的成员账户
- **权限范围**：仅限于被委派的服务
- **用途**：分散管理责任，遵循最小权限原则

## 组织设置与管理

### 创建组织
1. **初始设置**：
   - 使用将成为管理账户的 AWS 账户登录
   - 导航至 AWS Organizations 控制台
   - 选择"创建组织"
   - 选择功能集（所有功能或仅整合计费）

2. **添加账户**：
   - **创建新账户**：
     - 提供账户名称、电子邮件和 IAM 角色名称
     - 设置访问权限
   - **邀请现有账户**：
     - 输入账户 ID 或电子邮件
     - 等待接受邀请
   - **通过 API/CLI 自动化**：
     - 使用 CreateAccount API
     - 配置自动化脚本

### 组织结构设计
1. **设计原则**：
   - 基于业务单位划分
   - 按环境类型分组（开发、测试、生产）
   - 考虑安全边界和合规要求
   - 保持层次结构简单且可扩展

2. **创建组织单位**：
   - 在 Organizations 控制台中导航至"AWS 账户"
   - 选择要在其中创建 OU 的父级
   - 选择"操作">"创建新 OU"
   - 提供名称和可选描述

3. **移动账户**：
   - 选择要移动的账户
   - 选择"操作">"移动"
   - 选择目标 OU
   - 确认移动操作

## 策略管理

### 服务控制策略 (SCP)
1. **启用 SCP**：
   - 在组织设置中启用所有功能
   - 在策略类型下启用服务控制策略

2. **创建 SCP**：
   - 导航至"策略">"服务控制策略"
   - 选择"创建策略"
   - 使用可视化编辑器或 JSON 编辑器定义策略
   - 提供名称和描述

3. **策略类型**：
   - **拒绝列表策略**：默认允许所有操作，明确拒绝特定操作
   - **允许列表策略**：默认拒绝所有操作，明确允许特定操作

4. **附加 SCP**：
   - 选择目标（组织根、OU 或账户）
   - 选择"操作">"附加策略"
   - 选择要附加的 SCP
   - 确认附加操作

### 标签策略
1. **启用标签策略**：
   - 在组织设置中启用所有功能
   - 在策略类型下启用标签策略

2. **创建标签策略**：
   - 定义标签键和值规范
   - 设置合规要求（必需标签、大小写规范等）
   - 指定适用的资源类型

3. **附加和继承**：
   - 将策略附加到组织层次结构中的各级
   - 配置策略继承和合并规则

### 备份策略
1. **启用备份策略**：
   - 在组织设置中启用所有功能
   - 在策略类型下启用备份策略

2. **创建备份策略**：
   - 定义备份计划和保留规则
   - 指定备份保管库设置
   - 配置跨区域和跨账户复制

3. **应用备份策略**：
   - 将策略附加到组织层次结构中的各级
   - 监控备份合规性

## 账户管理

### 账户生命周期
1. **创建账户**：
   - 通过控制台手动创建
   - 使用 API 自动创建
   - 使用 AWS Control Tower 创建

2. **账户配置**：
   - 设置初始 IAM 角色
   - 应用基准安全设置
   - 配置默认 VPC 和网络设置

3. **账户暂停**：
   - 限制账户使用
   - 保留账户数据和配置
   - 随时可恢复使用

4. **账户关闭**：
   - 永久删除账户
   - 数据保留和备份考虑
   - 关闭前的准备步骤

### 跨账户访问
1. **IAM 角色设置**：
   - 创建跨账户角色
   - 配置信任关系
   - 设置权限边界

2. **角色切换**：
   - 控制台角色切换
   - CLI/SDK 角色承担
   - 联合身份用户的角色访问

3. **访问管理最佳实践**：
   - 实施最小权限原则
   - 定期轮换凭证
   - 使用条件限制访问

## 成本管理

### 整合计费
1. **计费设置**：
   - 查看整合账单
   - 配置账单偏好设置
   - 设置成本分配标签

2. **成本分配**：
   - 按账户分配成本
   - 使用成本类别分组支出
   - 创建自定义成本报告

3. **预算管理**：
   - 设置组织级预算
   - 配置预算警报
   - 监控支出趋势

### 成本优化
1. **Reserved Instance 共享**：
   - 启用 RI 折扣共享
   - 监控 RI 利用率
   - 优化 RI 购买策略

2. **Savings Plans 管理**：
   - 配置 Savings Plans
   - 监控承诺使用率
   - 优化承诺购买

3. **成本异常检测**：
   - 设置成本异常监控
   - 配置警报阈值
   - 调查和解决异常

## 安全与合规

### 安全最佳实践
1. **管理账户保护**：
   - 启用 MFA
   - 限制管理账户使用
   - 实施严格的访问控制

2. **安全监控**：
   - 集中日志记录
   - 配置 CloudTrail
   - 部署 GuardDuty

3. **合规性框架**：
   - 实施合规性控制
   - 定期审计和评估
   - 记录合规性证据

### 集中安全服务
1. **Security Hub 集成**：
   - 配置组织级 Security Hub
   - 委派安全管理员
   - 集中监控安全发现

2. **Config 集成**：
   - 部署组织级 Config 规则
   - 监控配置合规性
   - 自动修复不合规资源

3. **IAM Access Analyzer**：
   - 分析跨账户访问
   - 识别外部访问
   - 定期审查访问发现

## 多账户治理

### 账户治理框架
1. **账户标准化**：
   - 定义基准配置
   - 实施一致的命名约定
   - 标准化网络架构

2. **自动化部署**：
   - 使用 CloudFormation StackSets
   - 配置 Service Catalog
   - 实施基础设施即代码

3. **持续合规性**：
   - 自动化合规性检查
   - 定期审计和报告
   - 实施补救机制

### AWS Control Tower
1. **与 Organizations 集成**：
   - Control Tower 如何扩展 Organizations
   - 账户工厂与 Organizations 账户创建
   - 防护机制与 SCP 的关系

2. **Landing Zone 设置**：
   - 多账户架构设计
   - 账户基准配置
   - 安全控制实施

3. **持续治理**：
   - 偏差检测与修复
   - 合规性监控
   - 账户注册流程

## 高级功能

### 组织 API 和自动化
1. **API 操作**：
   - 账户管理 API
   - 策略操作 API
   - 组织结构 API

2. **自动化脚本示例**：
   - 账户创建自动化
   - 策略部署自动化
   - 合规性检查自动化

3. **事件驱动自动化**：
   - 使用 EventBridge 监控组织事件
   - 触发基于账户变更的工作流
   - 自动化安全响应

### 跨组织资源共享
1. **AWS RAM 集成**：
   - 共享 VPC 子网
   - 共享 Transit Gateway
   - 共享许可证配置

2. **集中式资源管理**：
   - 跨账户资源发现
   - 集中式标签管理
   - 资源合规性监控

## 最佳实践

### 组织设计
- **基于业务需求设计结构**：避免过度复杂化
- **考虑未来扩展**：设计可扩展的组织结构
- **平衡集中与分散控制**：根据治理需求调整

### 安全与访问控制
- **保护管理账户**：严格限制访问和使用
- **实施最小权限**：使用 SCP 限制权限范围
- **分层应用策略**：根据安全需求分层设计 SCP

### 成本管理
- **实施标记策略**：用于成本分配和跟踪
- **定期成本审查**：监控和优化支出
- **建立成本责任制**：明确各账户的成本责任

### 操作效率
- **自动化重复任务**：减少手动操作
- **标准化部署**：使用模板和基准配置
- **集中监控**：实施跨账户可观察性

## 故障排除

### 常见问题
- **策略继承问题**：检查策略附加点和优先级
- **账户移动限制**：了解账户移动的限制和要求
- **服务限额冲突**：管理跨账户服务限额

### 诊断步骤
1. **检查策略配置**
2. **验证权限和信任关系**
3. **查看服务限额**
4. **检查 CloudTrail 日志**
5. **联系 AWS Support**

## 案例研究

### 企业多账户架构
- **场景**：大型企业实施多账户战略
- **解决方案**：基于业务单位和环境的分层 OU 结构
- **结果**：改善安全态势和成本管理

### 合规性管理
- **场景**：受监管行业的合规性要求
- **解决方案**：使用 SCP 和委派管理员实施合规性控制
- **结果**：简化审计和持续合规性

## 参考资源
- [AWS Organizations 官方文档](https://docs.aws.amazon.com/organizations/)
- [AWS 多账户安全策略](https://docs.aws.amazon.com/whitepapers/latest/organizing-your-aws-environment/organizing-your-aws-environment.html)
- [AWS Control Tower 与 Organizations 集成](https://docs.aws.amazon.com/controltower/)
