# 14. Docker 安全最佳实践

将应用程序容器化可以带来许多好处，但同时也引入了新的安全挑战。确保 Docker 环境和容器的安全是任何生产部署的重中之重。本章将介绍一系列保护你的容器化工作负载的最佳实践。

安全是一个分层的概念，我们需要从宿主机到镜像再到容器运行时，层层设防。

## 1. 宿主机安全 (Host Security)

容器与宿主机共享内核，因此宿主机的安全是整个系统的基石。如果宿主机被攻破，那么在其上运行的所有容器都将岌岌可危。

-   **保持宿主机系统更新**: 定期为宿主机操作系统打上最新的安全补丁。
-   **保护 Docker 守护进程**:
    -   Docker 守护进程的套接字 (`/var/run/docker.sock`) 是一个强大的控制点。能够访问此套接字的用户基本上拥有了对宿主机的 root 权限。
    -   **严格限制**对 `/var/run/docker.sock` 的访问权限。
    -   切勿将 `/var/run/docker.sock` 挂载到不可信的容器内部。
-   **使用防火墙**: 配置宿主机的防火墙（如 `iptables`, `ufw`），只暴露必要的端口。
-   **遵循最小权限原则**: 只安装运行 Docker 和必要监控工具所需的最小软件包集。

## 2. 镜像安全 (Image Security)

镜像是应用的打包格式，确保其安全性至关重要。

-   **使用可信的基础镜像**:
    -   始终从**官方仓库**或你自己的组织内部受信任的私有仓库中拉取基础镜像。
    -   避免使用 Docker Hub 上来历不明、无人维护的社区镜像。
    -   检查 `Dockerfile`，了解镜像是如何构建的。

-   **定期扫描镜像漏洞**:
    -   镜像中可能包含带有已知漏洞 (CVEs) 的软件包。定期扫描镜像是必须执行的安全流程。
    -   **`docker scan`**: Docker Desktop 和 Docker Hub 集成了 Snyk 提供的 `docker scan` 命令，可以方便地扫描本地镜像的漏洞。
        ```bash
        docker scan my-app:latest
        ```
    -   **其他工具**: Trivy, Clair, Grype 都是流行的开源镜像扫描工具，可以轻松集成到 CI/CD 流水线中。

-   **最小化镜像**:
    -   我们之前在"镜像优化"中讨论的策略——选择 `alpine` 或 `distroless` 等小镜像，并使用多阶段构建——同样是核心的安全实践。镜像中包含的组件越少，其潜在的攻击面就越小。

## 3. 容器运行时安全 (Container Runtime Security)

-   **不要以 Root 用户运行容器 (最重要的实践)**:
    -   默认情况下，容器内的进程是以 `root` 用户身份运行的。如果攻击者在容器内获得了执行权限，他将拥有容器文件系统的完全控制权，并可能利用内核漏洞来攻击宿主机。
    -   **最佳实践**: 在 `Dockerfile` 中创建并切换到一个非特权用户。
    ```Dockerfile
    FROM alpine
    
    # 创建一个非特权用户和组
    RUN addgroup -S appgroup && adduser -S appuser -G appgroup
    
    # 切换到这个用户
    USER appuser
    
    WORKDIR /home/appuser
    COPY . .
    CMD ["./my-app"]
    ```

-   **使用只读文件系统**:
    -   通过 `--read-only` 标志以只读模式启动容器，可以防止攻击者修改容器内的文件或写入恶意脚本。
    -   只在应用明确需要写入的路径上挂载可写的 `tmpfs` 或命名卷。
    ```bash
    docker run --read-only \
               --mount type=tmpfs,destination=/tmp \
               -v my-data:/app/data \
               my-app:latest
    ```

-   **限制容器资源**:
    -   通过限制容器可以使用的 CPU 和内存，可以防止单个容器因漏洞或恶意行为耗尽主机资源，从而对其他容器造成拒绝服务 (DoS) 攻击。
    ```bash
    docker run -d --memory="256m" --cpus="0.5" my-app:latest
    ```

-   **限制 Linux 内核能力 (Capabilities)**:
    -   默认情况下，Docker 会移除一些危险的内核能力，但仍保留了一些。遵循最小权限原则，你应该移除容器不需要的所有能力。
    ```bash
    # 移除所有能力，然后只添加应用必需的能力 (如果需要)
    docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE my-app:latest
    ```

-   **使用安全计算模式 (Seccomp)**:
    -   Seccomp 可以用来限制容器内进程可以执行的系统调用 (syscalls)。Docker 默认提供了一个 Seccomp 配置文件，它禁用了大约 44 个不常用的或有风险的系统调用。
    -   对于高度安全敏感的应用，你可以创建自定义的 Seccomp 配置文件，只允许应用正常工作所需的最小系统调用集合。

## 4. 私有仓库安全

-   **强制认证和授权**: 对你的私有镜像仓库（如 Harbor, Artifactory）启用强认证，并使用基于角色的访问控制 (RBAC) 来限制哪些用户或服务账号可以推送或拉取特定的镜像。
-   **定期清理**: 建立策略，定期清理旧的、未使用的和已发现漏洞的镜像。

安全是一个持续的过程，而不是一次性的任务。将这些最佳实践融入到你的开发和运维流程中，是构建和维护一个健壮、可靠的容器化平台的基础。 