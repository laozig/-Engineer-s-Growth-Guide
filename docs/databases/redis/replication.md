# Redis 主从复制

Redis 主从复制是构建高可用和可扩展 Redis 服务的基础。通过主从复制，可以将一台 Redis 服务器（主节点，Master）的数据，实时、异步地同步到其他 Redis 服务器（从节点，Slave）。

## 目录
- [主从复制的作用](#主从复制的作用)
- [工作原理](#工作原理)
  - [全量同步 (Full Synchronization)](#全量同步-full-synchronization)
  - [增量同步 (Incremental Synchronization)](#增量同步-incremental-synchronization)
  - [心跳机制](#心跳机制)
- [如何配置主从复制](#如何配置主从复制)
  - [配置文件方式](#配置文件方式)
  - [命令行方式](#命令行方式)
- [常见问题与运维要点](#常见问题与运维要点)
  - [数据延迟](#数据延迟)
  - [主节点故障处理](#主节点故障处理)
  - [复制风暴](#复制风暴)
  - [无盘复制](#无盘复制)
- [相关命令](#相关命令)
- [总结](#总结)

---

## 主从复制的作用

1.  **数据冗余与备份**：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。当主节点出现故障时，可以快速切换到从节点，保证服务的连续性。
2.  **读写分离**：通过将读请求分散到多个从节点，可以显著提高 Redis 的并发读能力。主节点专注于处理写请求，从节点处理读请求，从而提升整体性能和扩展性。
3.  **高可用基础**：主从复制是哨兵（Sentinel）和集群（Cluster）模式实现高可用的基础。

## 工作原理

Redis 的主从复制过程主要分为全量同步和增量同步。

### 全量同步 (Full Synchronization)

当一个从节点第一次连接到主节点，或者增量同步无法进行时，会触发全量同步。

**步骤：**
1.  **PSYNC 命令**：从节点向主节点发送 `PSYNC ? -1` 命令，请求全量同步。
2.  **BGSAVE**：主节点收到请求后，执行 `BGSAVE` 在后台生成一个 RDB 快照文件。
3.  **复制缓冲区**：在 `BGSAVE` 期间，主节点会将所有新的写命令记录在一个内存缓冲区中（复制缓冲区）。
4.  **发送 RDB 文件**：主节点完成 `BGSAVE` 后，将生成的 RDB 文件发送给从节点。
5.  **加载 RDB**：从节点接收到 RDB 文件后，会清空自己的旧数据，然后加载 RDB 文件到内存中。
6.  **发送缓冲命令**：主节点将复制缓冲区中积累的写命令发送给从节点。
7.  **应用命令**：从节点执行这些写命令，最终达到和主节点数据一致的状态。

### 增量同步 (Incremental Synchronization)

从 Redis 2.8 开始，引入了增量同步（也称为部分重同步）。如果从节点因网络问题等原因与主节点断开连接，在重新连接后，如果条件允许，它只需要同步断开期间丢失的数据，而无需进行全量同步。

**条件：**
主节点的复制积压缓冲区（Replication Backlog）中仍然存有从节点断开时的数据。

**步骤：**
1.  **PSYNC 命令**：从节点连接主节点后，发送 `PSYNC <runid> <offset>` 命令，其中 `runid` 是它上次连接的主节点的运行ID，`offset` 是它已经同步的数据偏移量。
2.  **主节点判断**：主节点检查 `runid` 是否匹配，以及请求的 `offset` 是否在复制积压缓冲区内。
3.  **发送增量数据**：如果条件满足，主节点会从复制积压缓冲区中找到从节点需要的数据，并将其发送给从节点。从节点接收并执行这些命令即可。
4.  **回退到全量同步**：如果 `runid` 不匹配或 `offset` 已被覆盖，则无法进行增量同步，主从复制会退化为全量同步。

### 心跳机制

在主从连接正常期间，双方会通过心跳机制来维持连接和检测状态。
-   从节点会周期性地（默认每秒）向主节点发送 `REPLCONF ACK <offset>` 命令，报告自己的复制偏移量。
-   主节点通过这个心跳来判断从节点是否在线，并监控数据同步的进度。

## 如何配置主从复制

假设主节点 IP 为 `192.168.1.1`，端口为 `6379`。

### 配置文件方式

在**从节点**的 `redis.conf` 文件中添加或修改以下配置：
```conf
# Redis 5.0 之前使用 slaveof
# slaveof <masterip> <masterport>
slaveof 192.168.1.1 6379

# 如果主节点设置了密码
# masterauth <master-password>

# Redis 5.0 及之后版本推荐使用 replicaof
replicaof 192.168.1.1 6379
masterauth <master-password>
```
修改配置后，重启从节点服务即可。

### 命令行方式

在**从节点**的 `redis-cli` 中执行以下命令，可以动态地让一个节点成为从节点：
```
# Redis 5.0 之前
> SLAVEOF 192.168.1.1 6379

# Redis 5.0 及之后
> REPLICAOF 192.168.1.1 6379
```
要取消复制，执行 `REPLICAOF NO ONE`。

## 常见问题与运维要点

### 数据延迟
由于主从复制是异步的，从节点的数据相对于主节点存在一定的延迟。延迟的大小取决于网络状况、主节点负载以及复制积压缓冲区的大小。可以通过 `INFO replication` 命令查看主从节点的偏移量差距来监控延迟。

### 主节点故障处理
主从复制本身不具备自动故障转移的能力。如果主节点宕机，需要人工介入或通过哨兵（Sentinel）/集群（Cluster）方案来将其中一个从节点提升为新的主节点。

### 复制风暴
如果一个主节点下挂载了大量的从节点，当主节点重启或故障恢复后，所有从节点都会同时发起全量同步请求，这会导致主节点需要多次执行 `BGSAVE` 并传输 RDB 文件，对主节点造成巨大的网络和 CPU 压力，称为"复制风暴"。

**解决方案**：可以调整从节点的拓扑结构，例如 `slave1 -> master`，`slave2 -> slave1`，`slave3 -> slave1`，形成一个树状结构，减轻主节点的压力。

### 无盘复制 (`repl-diskless-sync`)
默认情况下，全量同步时主节点会将 RDB 文件写入磁盘，然后再发送给从节点。对于磁盘 I/O 较慢的系统，这会成为瓶颈。开启无盘复制后，主节点会直接将 RDB 内容通过网络套接字发送给从节点，避免了磁盘写入的开销。

## 相关命令
- `INFO replication`: 查看主从复制的详细信息，包括角色、连接状态、偏移量等。
- `REPLICAOF <masterip> <masterport>`: 将当前实例设置为从节点。
- `REPLICAOF NO ONE`: 使当前从节点停止复制，并转为主节点。
- `ROLE`: 显示当前实例的角色（master, slave, sentinel）。

## 总结
Redis 主从复制是构建分布式、高可用 Redis 系统的核心机制。它通过异步方式将数据从主节点同步到从节点，实现了数据备份和读写分离。理解其全量同步和增量同步的原理，以及相关的运维要点，对于保障 Redis 服务的稳定性和可扩展性至关重要。 