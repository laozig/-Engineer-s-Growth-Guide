# 3. MySQL 架构 (MySQL Architecture)

理解 MySQL 的架构是优化数据库性能、排查问题和有效利用其功能的关键。MySQL 的架构可以分为两层：MySQL 服务器层 (Server Layer) 和存储引擎层 (Storage Engine Layer)。

![MySQL Architecture](https://i.imgur.com/8z4Jz9g.png)
*图: MySQL 逻辑架构图*

## MySQL 逻辑架构

### 1. 连接层 (Connection Layer)

最上层是客户端/连接服务。它不属于 MySQL 服务器的核心部分，但却是与服务器交互的入口。这一层主要负责：

- **连接处理**: 接收来自各种客户端（如命令行、应用程序、GUI 工具）的连接请求。
- **线程管理**: 为每个客户端连接分配一个线程。服务器会维护一个线程池，以避免频繁创建和销毁线程带来的开销。
- **用户认证**: 验证客户端提供的用户名和密码是否有效，并检查用户拥有的权限。
- **安全性**: 提供基于 SSL/TLS 的加密连接，确保数据传输过程中的安全。

### 2. MySQL 服务器层 (MySQL Server Layer)

这是 MySQL 的核心，包含了大部分的逻辑功能。它位于连接层之下，存储引擎层之上。主要组件包括：

- **SQL 接口 (SQL Interface)**: 接收客户端发送的 SQL 命令（如 DQL, DML, DDL），并返回结果。
- **查询解析器 (Parser)**: 对 SQL 语句进行语法分析，检查其是否符合 SQL 语法规则，并生成一个"解析树"。
- **查询优化器 (Optimizer)**: 这是 MySQL 的"大脑"。它接收解析树，并根据一系列复杂的算法和统计信息（如索引、表大小等）生成一个最优的执行计划。例如，它会决定使用哪个索引、表的连接顺序等。`EXPLAIN` 命令可以让你看到优化器选择的执行计划。
- **缓存与缓冲 (Caches & Buffers)**:
    - **查询缓存 (Query Cache)**: (在 MySQL 8.0 中已废弃) 之前用于缓存 `SELECT` 查询的完整结果集。由于在数据频繁更新的场景下效率低下，已被移除。
    - **InnoDB 缓冲池 (Buffer Pool)**: 这是 InnoDB 存储引擎最重要的部分，用于缓存数据和索引页。通过在内存中完成大部分读写操作，极大地提升了性能。
    - **Key Buffer**: MyISAM 存储引擎使用的索引缓存。
    - **其他缓存**: 如线程缓存、表缓存等。

### 3. 存储引擎层 (Storage Engine Layer)

存储引擎层负责数据的物理存储和提取。MySQL 的一个显著特点是其**可插拔的存储引擎架构**，这意味着你可以根据应用的具体需求选择不同的存储引擎。

存储引擎是与底层文件系统打交道的组件，它们控制着数据的存储方式、索引技术、锁定级别等。

#### 常见存储引擎对比

| 特性 | InnoDB | MyISAM | Memory | Archive |
| :--- | :--- | :--- | :--- | :--- |
| **事务 (Transactions)** | **支持 (ACID)** | 不支持 | 不支持 | 不支持 |
| **锁定级别 (Locking)** | **行级锁 (Row-level)** | 表级锁 (Table-level) | 表级锁 | 行级锁 |
| **外键 (Foreign Keys)** | **支持** | 不支持 | 不支持 | 不支持 |
| **崩溃恢复 (Recovery)** | **支持** | 不支持 (需手动修复) | 不支持 (数据丢失) | 不支持 |
| **主要用途** | 事务性应用, 高并发 | 读取密集型应用, 全文搜索 | 临时表, 缓存 | 日志, 归档数据 |
| **数据存储** | 磁盘 | 磁盘 | 内存 | 压缩后存入磁盘 |

#### InnoDB 存储引擎

自 MySQL 5.5 版本以来，**InnoDB** 是默认的存储引擎，也是功能最全面、使用最广泛的引擎。它的主要优点包括：

- **ACID 事务支持**: 保证了数据操作的原子性、一致性、隔离性和持久性，是大多数要求数据完整性的应用（如金融、电商）的首选。
- **行级锁定**: 在高并发场景下，行级锁定提供了更好的性能，因为它只锁定需要修改的行，而不是整张表。
- **外键约束**: 支持外键，可以保证数据的引用完整性。
- **崩溃恢复能力**: 通过日志机制（如 Redo Log, Undo Log），InnoDB 可以在数据库崩溃后自动恢复数据，保证了高可靠性。
- **聚集索引**: InnoDB 的表是基于主键的聚集索引结构，这使得基于主键的查询速度非常快。

#### MyISAM 存储引擎

在 InnoDB 成为默认引擎之前，MyISAM 是最常用的引擎。它的特点是：

- **读取性能高**: 由于其结构简单，没有事务开销，MyISAM 在只读或读多写少的场景下性能优异。
- **全文索引**: MyISAM 支持全文索引，适用于文本搜索。
- **表级锁定**: 任何写操作都会锁定整张表，这在高并发写入时会成为性能瓶颈。
- **不支持事务和外键**: 这限制了它在需要数据完整性的复杂应用中的使用。

## 物理文件结构

MySQL 的数据最终以文件的形式存储在服务器的文件系统中。这些文件的位置由 `datadir` 配置变量指定。

- **`ibdata1`**: 在默认配置下，这是 InnoDB 的系统表空间文件，存储了数据字典、Undo 日志等。
- **`.frm` 文件**: (在 MySQL 8.0 之前) 存储了表的定义（结构信息）。8.0 之后，表的元数据存储在数据字典中。
- **`.ibd` 文件**: 如果开启了 `innodb_file_per_table` (默认开启)，每个 InnoDB 表的数据和索引会存储在自己的 `.ibd` 文件中。
- **`.MYD` 和 `.MYI` 文件**: 分别是 MyISAM 表的数据文件 (Data) 和索引文件 (Index)。
- **日志文件**:
    - **错误日志 (Error Log)**: 记录了 MySQL 服务器启动、运行和关闭过程中的错误信息。
    - **二进制日志 (Binary Log / binlog)**: 记录了所有修改数据的 SQL 语句，主要用于数据复制和恢复。
    - **查询日志 (Query Log)**: 记录所有连接和执行的 SQL 语句，通常用于调试，但会影响性能。
    - **慢查询日志 (Slow Query Log)**: 记录执行时间超过指定阈值的查询，用于性能优化。
    - **重做日志 (Redo Log)** 和 **撤销日志 (Undo Log)**: InnoDB 特有的日志，用于实现事务和崩溃恢复。

通过了解这些组件如何协同工作，你就能更好地理解 MySQL 的行为，并在遇到问题时进行有效的诊断和优化。 