# 19. 高可用性与复制

对于生产环境中的关键业务系统，单个数据库实例是远远不够的，因为它存在单点故障（Single Point of Failure, SPOF）的风险。高可用性（High Availability, HA）的目标是最大限度地减少因硬件故障、软件问题或维护带来的停机时间。在PostgreSQL中，这通常通过复制（Replication）来实现。

## 复制的基本概念

复制是指将数据从一个PostgreSQL数据库服务器（称为**主库/Primary**）拷贝到另一个服务器（称为**备库/Standby**或**副本/Replica**）的过程。

**复制的主要目的**:
- **高可用性 (High Availability)**: 如果主库发生故障，可以将一个备库提升（Promote）为新的主库，从而快速恢复服务。
- **读扩展 (Read Scaling)**: 可以将读密集型的查询负载（如分析、报表）分发到多个备库上，从而减轻主库的压力。
- **备份**: 备库可以作为热备份，用于执行备份操作而无需影响主库。

## 流复制 (Streaming Replication)

流复制是PostgreSQL内置的最常用、最高效的复制方法。它自PostgreSQL 9.0版本引入，并在此后不断增强。

### 工作原理

1.  **主库 (Primary)**: 主库是唯一接受写操作（`INSERT`, `UPDATE`, `DELETE`）的服务器。它在执行写操作时会产生预写式日志（Write-Ahead Log, WAL）。
2.  **WAL发送进程 (WAL Sender)**: 在主库上，有一个或多个WAL发送进程，负责将WAL记录通过网络实时地发送给备库。
3.  **备库 (Standby)**: 备库连接到主库，并有一个**WAL接收进程 (WAL Receiver)**来接收这些WAL记录。
4.  **重放 (Replay)**: 备库接收到WAL记录后，会持续地"重放 (Replay)"这些记录，从而将其自身的数据状态与主库保持同步。

这种方式几乎是实时的，备库的数据可以只比主库落后几毫秒。

### 同步 vs. 异步复制

流复制可以是异步的，也可以是同步的。

- **异步复制 (Asynchronous Replication)** - **默认模式**:
  - 主库在提交一个事务时，**不需要**等待备库确认已收到WAL记录。
  - **优点**: 对主库的性能影响最小，不会因为备库的延迟或宕机而阻塞主库的写操作。
  - **缺点**: 如果主库在提交事务后、而备库尚未收到WAL记录之前发生崩溃，那么这个事务的数据可能会丢失。存在数据丢失的风险（RPO > 0）。

- **同步复制 (Synchronous Replication)**:
  - 主库在提交一个事务时，**必须**等待至少一个（或指定的多个）同步备库确认已经将该事务的WAL记录写入到其磁盘上。
  - **优点**: 提供了更高的数据持久性保证。如果一个事务在主库上提交成功，那么可以确保它至少也存在于一个备库上，从而防止数据丢失（RPO = 0）。
  - **缺点**: 对主库性能有影响，因为每次提交都需要等待网络往返。如果同步备库宕机，主库的写操作会被阻塞，直到备库恢复或配置被修改。

您可以在`postgresql.conf`中通过`synchronous_commit`和`synchronous_standby_names`参数来配置同步复制。

## 故障转移 (Failover)

当主库确认发生故障时，需要执行故障转移流程，将一个备库提升为新的主库。

- **手动故障转移**:
  1.  确认主库无法恢复。
  2.  在选定的备库上，使用`pg_ctl promote`命令或创建触发器文件来将其提升为新的主库。
  3.  应用程序需要将它们的数据库连接切换到这个新的主库地址。
  4.  其他旧的备库需要重新配置，以指向这个新的主库。

- **自动故障转移**:
  手动故障转移过程可能很慢且容易出错。在生产环境中，通常使用专门的高可用性管理工具来实现自动故障转移。这些工具负责：
  - **健康检查**: 持续监控主库的健康状态。
  - **故障检测**: 准确地判断主库是否真的发生了故障。
  - **领导者选举**: 在多个备库中选择一个最合适的（通常是数据最新的）来提升。
  - **自动提升与切换**: 自动执行提升命令，并可能通过更新DNS、虚拟IP（VIP）或服务发现机制来重新路由应用程序的流量。

**流行的HA管理工具**:
- **Patroni**: 目前最流行和功能最丰富的HA解决方案。它使用分布式配置存储（如etcd, Consul, ZooKeeper）来管理集群状态，并能自动化几乎所有的故障转移和集群管理任务。
- **pg_auto_failover**: 一个由CitusData（微软）开发的更简单、更易于上手的HA工具。
- **repmgr**: 一个历史悠久的管理复制和故障转移的工具套件。

## 逻辑复制 (Logical Replication)

逻辑复制是自PostgreSQL 10引入的一种更灵活的复制方法。

与流复制（物理复制）不同，逻辑复制不是基于WAL的物理块变更，而是基于**逻辑数据变更**（如一行被插入、更新或删除）。

### 逻辑复制的优势

- **跨版本复制**: 可以在不同主版本的PostgreSQL之间进行复制（例如，从11复制到13）。
- **选择性复制**: 您可以选择只复制某个数据库中的特定表，甚至可以只复制满足特定条件的行。
- **多主复制**: 虽然核心不支持，但可以作为构建多主复制解决方案的基础。
- **格式灵活**: 备库上的表结构可以与主库不同。

### 工作原理

逻辑复制使用**发布/订阅 (Publish/Subscribe)**模型：
1.  **发布 (Publication)**: 在主库上，创建一个`PUBLICATION`，声明您想要发布哪些表的变更（`INSERT`, `UPDATE`, `DELETE`）。
2.  **订阅 (Subscription)**: 在备库上，创建一个`SUBSCRIPTION`，来订阅主库上的一个或多个发布。

逻辑复制为数据集成、数据库升级和更复杂的复制拓扑提供了极大的灵活性，但对于单纯的高可用性场景，基于WAL的流复制通常更简单、性能更高。 