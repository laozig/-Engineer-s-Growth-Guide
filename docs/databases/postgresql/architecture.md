# 3. PostgreSQL 体系结构

理解PostgreSQL的体系结构是有效使用和管理它的关键。其设计哲学是健壮、可扩展和标准兼容。本章将介绍其核心的进程和内存结构。

## 体系结构概览

PostgreSQL 采用客户端/服务器 (C/S) 模型。一个PostgreSQL会话由以下几个部分组成：

- **Postmaster (主进程)**: 这是数据库实例启动时运行的第一个进程。它负责监听客户端连接请求，并为每个连接创建一个新的服务进程（`postgres` process）。它还负责执行数据库的启动和关闭、恢复操作以及管理后台辅助进程。
- **Postgres (服务进程)**: 每个客户端连接都会有一个专门的 `postgres` 服务进程。这个进程代表客户端处理所有的查询和操作。客户端和它的服务进程通过TCP/IP套接字进行通信。
- **共享内存 (Shared Memory)**: 这是所有PostgreSQL进程共享的一块内存区域，用于缓存数据、事务日志、锁信息等，以提高性能和协调并发。
- **后台辅助进程 (Background Processes)**: 这些进程由Postmaster启动和管理，负责数据库的各种维护任务，如日志写入、数据刷盘、自动清理等。
- **数据文件 (Data Files)**: 存储在磁盘上的物理文件，包含了表、索引、视图等所有数据库对象的数据。

![PostgreSQL Architecture Diagram](https://www.researchgate.net/profile/Andres-Quiroz-6/publication/320148455/figure/fig1/AS:631654848593933@1527609653378/PostgreSQL-Architecture-Diagram.png)
*(图片来源: ResearchGate)*

## 进程结构

### Postmaster (主进程/监听进程)

作为所有进程的父进程，`postmaster` 的主要职责是：
1.  **监听连接**: 在指定的端口（默认为5432）上等待新的客户端连接。
2.  **派生子进程**: 当接收到新的连接请求时，`postmaster` 会 `fork()` 一个新的 `postgres` 服务进程来处理该连接。
3.  **管理后台进程**: 启动并监控各种后台工作进程。
4.  **优雅关闭**: 接收并处理关闭数据库实例的信号。
5.  **崩溃恢复**: 如果 `postgres` 服务进程或后台进程崩溃，`postmaster` 会终止所有其他进程并启动恢复过程。

### Postgres (服务进程/后台进程)

每个客户端连接都由一个独立的 `postgres` 进程服务。这种多进程模型带来了出色的稳定性和隔离性：一个服务进程的崩溃不会影响到其他连接。服务进程的主要工作是：
1.  **解析和执行SQL**: 接收客户端发来的SQL查询，进行语法解析、查询重写、生成执行计划并最终执行。
2.  **数据访问**: 从共享缓冲区或磁盘读取所需的数据页。
3.  **并发控制**: 使用MVCC和锁机制来处理并发事务。
4.  **返回结果**: 将查询结果返回给客户端。

### 后台辅助进程

PostgreSQL有多个重要的后台进程，协同工作以保证数据库的稳定运行：

- **Checkpointer (检查点进程)**: 负责定期将共享内存中的"脏"数据页（已修改但未写入磁盘的数据）写入数据文件，创建"检查点"，以缩短崩溃恢复的时间。
- **Writer (后台写入进程)**: 帮助Checkpointer将脏数据页写入磁盘，减轻主服务进程的I/O负担。
- **WAL Writer (预写日志写入进程)**: 负责将WAL缓冲区中的事务日志记录写入到持久化的WAL文件中。这是保证数据持久性的关键。
- **Autovacuum Launcher (自动清理启动进程)**: 启动 `autovacuum worker` 进程来执行自动清理任务。
- **Autovacuum Worker (自动清理工作进程)**: 负责回收已删除或过时行所占用的空间，并更新表的统计信息以供查询优化器使用。
- **Archiver (归档进程)**: 如果开启了归档模式，此进程负责将已写满的WAL文件复制到指定的归档位置。
- **Stats Collector (统计信息收集进程)**: 收集关于表和索引访问的统计数据。

## 内存结构

PostgreSQL的内存主要分为两部分：

### 共享内存 (Shared Memory)

这是所有进程共享的区域，在数据库启动时分配。主要包括：

- **Shared Buffers**: 这是最大的一块共享内存区域，用于缓存从磁盘读取的数据页。当服务进程需要数据时，它首先在共享缓冲区中查找。如果找到（缓存命中），则避免了昂贵的磁盘I/O。
- **WAL Buffers**: 用于暂存即将写入WAL文件的事务日志记录。
- **Commit Log (CLOG) Buffers**: 缓存事务的提交状态（提交、中止、进行中），是MVCC实现的一部分。
- **Lock Space**: 存储锁信息，用于管理对数据库对象的并发访问。

### 本地内存 (Local Memory)

每个 `postgres` 服务进程都拥有自己私有的本地内存区域，用于执行查询。主要包括：

- **work_mem**: 用于执行排序、哈希连接、位图扫描等操作。当操作所需内存超过 `work_mem` 时，会使用临时磁盘文件。
- **maintenance_work_mem**: 用于执行维护性命令，如 `VACUUM`, `CREATE INDEX`, `ALTER TABLE ADD FOREIGN KEY` 等。
- **temp_buffers**: 用于存储临时表的缓存。

理解了这些基础架构后，我们就可以在下一章开始学习 [SQL基础](sql-basics.md) 了。 