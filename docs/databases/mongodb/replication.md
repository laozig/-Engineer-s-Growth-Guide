# MongoDB 复制集 (Replica Sets)

复制集（Replica Set）是 MongoDB 提供数据冗余和高可用性的核心解决方案。一个复制集是一组维护相同数据集的 `mongod` 进程。通过在多台服务器上存储数据的副本，复制集可以在单台服务器发生故障时提供保护，确保数据库服务的连续性。

## 目录
- [复制集解决了什么问题？](#复制集解决了什么问题)
- [复制集架构与成员角色](#复制集架构与成员角色)
  - [Primary (主节点)](#primary-主节点)
  - [Secondary (从节点)](#secondary-从节点)
  - [Arbiter (仲裁者)](#arbiter-仲裁者)
- [数据同步：Oplog](#数据同步oplog)
- [选举 (Election)](#选举-election)
  - [触发选举的条件](#触发选举的条件)
  - [选举过程](#选举过程)
- [读写关注点 (Read/Write Concerns)](#读写关注点-readwrite-concerns)
  - [写关注点 (Write Concern)](#写关注点-write-concern)
  - [读偏好 (Read Preference)](#读偏好-read-preference)
- [部署一个基本的复制集](#部署一个基本的复制集)
- [常见问题 (FAQ)](#常见问题-faq)

---

## 复制集解决了什么问题？

1.  **数据冗余与备份**：数据被复制并存储在多个服务器上，防止因单点硬件故障导致数据丢失。
2.  **高可用性 (High Availability)**：当主节点（Primary）宕机时，复制集会自动进行**故障转移 (Failover)**，从从节点（Secondary）中选举出一个新的主节点来接管服务，从而将停机时间降至最低。
3.  **读写分离**：可以将读取请求分发到从节点，从而分担主节点的读取压力，提高应用的整体吞吐量。

一个典型的生产环境部署**至少**包含三个成员的复制集。

## 复制集架构与成员角色

一个复制集由多种角色的成员组成。

### Primary (主节点)

-   一个复制集中**有且仅有一个**主节点。
-   它是唯一**接收所有写操作**的节点。客户端的插入、更新、删除请求都必须发送到主节点。
-   主节点会将所有的数据变更记录到一个特殊的集合，称为操作日志（`oplog`）。
-   默认情况下，所有读操作也由主节点处理。

### Secondary (从节点)

-   从节点异步地从主节点复制 `oplog`，并在自己的数据集上重放这些操作，从而与主节点保持数据同步。
-   从节点**不能**接收写操作。
-   它们可以处理读操作（通过设置读偏好），实现读写分离。
-   在主节点失效时，它们有资格被选举为新的主节点。

### Arbiter (仲裁者)

-   仲裁者是一个特殊的 `mongod` 进程，它**不存储任何数据副本**，也不从主节点同步数据。
-   它的唯一作用是在选举中**投票**。
-   当复制集成成员为偶数时，可以添加一个仲裁者来打破僵局，确保总票数为奇数，从而避免选举失败。
-   仲裁者资源开销极小，但会增加网络复杂性，且不能提供数据冗余。**通常建议优先使用数据承载节点（Primary/Secondary）来构成奇数成员的复制集**。

**推荐配置**：3个数据节点（1P, 2S），或 5个数据节点（1P, 4S）。避免使用偶数个数据节点的配置。

## 数据同步：Oplog

Oplog (Operations Log) 是主节点上的一个特殊的、有上限的集合（Capped Collection），它存储了所有改变数据库状态的写操作。
-   每个操作都在 oplog 中记录为一个文档。
-   从节点持续不断地监控主节点的 oplog，并将新的操作条目复制到本地，然后在自己的数据集上应用这些操作。
-   由于 oplog 是幂等的（多次应用同一个操作结果不变），从节点可以安全地重放这些操作来与主节点同步。
-   如果一个从节点宕机时间过长，导致它需要同步的 oplog 记录已经被主节点上新的记录覆盖（因为 oplog 有大小上限），那么它将无法通过常规方式同步，可能需要进行代价高昂的**初始同步 (Initial Sync)**。

## 选举 (Election)

当从节点无法与主节点建立连接（例如，心跳超时）时，就会触发选举，以选出新的主节点。

### 触发选举的条件

-   主节点宕机或网络不可达。
-   通过 `rs.stepDown()` 等命令手动触发。
-   新初始化的复制集。

### 选举过程

1.  一个发现主节点不可达的从节点会发起选举，请求其他成员投票给自己。
2.  其他健康的从节点会进行检查，如果它们也认为主节点不可达，并且发起选举的节点的数据足够新（通常是通过比较 oplog 的最新时间戳），它们就会投票给该候选人。
3.  一旦一个候选人获得了复制集中**大多数（`majority`）**成员的投票，它就会成为新的主节点。
4.  旧的主节点（如果恢复）会降级为从节点，并开始从新的主节点同步数据。

"大多数" 是指超过半数的投票成员。例如，在一个3成员的复制集中，需要2票才能当选。在一个5成员的复制集中，需要3票。这就是为什么推荐使用奇数成员的原因。

## 读写关注点 (Read/Write Concerns)

### 写关注点 (Write Concern)

写关注点决定了写操作在向客户端确认成功之前，需要得到多少个复制集成员的确认。

-   `w: 1` (默认): 写操作在主节点应用后即返回成功。性能最好，但如果主节点在将操作复制到从节点前宕机，数据可能会丢失。
-   `w: "majority"`: 写操作必须被复制到**大多数**数据承载节点后才返回成功。这是推荐的设置，因为它能有效防止在故障转移期间发生数据回滚。
-   `j: true`: 要求写操作在返回前写入到磁盘日志（journal）。

### 读偏好 (Read Preference)

读偏好决定了驱动程序将读请求路由到哪个/哪些节点。

-   `primary` (默认): 所有读请求都发往主节点。保证了数据是最新的（强一致性）。
-   `primaryPreferred`: 优先从主节点读取，如果主节点不可用，则从从节点读取。
-   `secondary`: 所有读请求都发往从节点。适用于对数据一致性要求不高的分析类查询。
-   `secondaryPreferred`: 优先从从节点读取，如果没有可用的从节点，则从主节点读取。
-   `nearest`: 从网络延迟最低的节点读取（不关心角色）。

**注意**：在从节点上读取数据可能会读到"旧"数据（最终一致性），因为从节点的数据同步存在延迟。

## 部署一个基本的复制集

（本节提供概念性步骤，具体命令请参考官方文档）

1.  启动多个 `mongod` 实例，每个实例都使用 `--replSet <replicaSetName>` 参数，并指定相同的复制集名称。
2.  连接到其中一个实例。
3.  执行 `rs.initiate()` 命令来初始化复制集。可以传入一个配置对象来指定初始成员。
4.  使用 `rs.add()` 来添加更多成员，或 `rs.addArb()` 添加仲裁者。
5.  使用 `rs.status()` 查看复制集的状态。

复制集是构建生产级 MongoDB 服务的基石，深刻理解其工作原理对于保证系统的高可用和数据安全至关重要。 