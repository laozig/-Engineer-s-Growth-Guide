# MongoDB 应用开发最佳实践

本指南为使用 MongoDB 构建应用程序的开发者提供了一系列最佳实践。遵循这些建议可以帮助您构建出性能更高、可扩展性更强、更易于维护的应用程序。

## 1. 连接管理

- **使用连接池 (Connection Pooling)**：
  - **不要为每个请求创建新连接**。数据库连接的建立和销毁是有成本的。几乎所有的 MongoDB 官方和社区驱动程序都内置了连接池。
  - **正确配置连接池大小**。连接池大小应根据您的应用程序并发请求数进行调整。过小的连接池会导致请求等待，而过大的连接池会消耗不必要的服务器资源。默认值通常是一个好的起点。
  - **单例模式管理 `MongoClient`**。在您的应用程序中，应创建一个 `MongoClient` 的单例实例，并在整个应用程序生命周期内共享它。

## 2. Schema 设计

- **数据建模应反映访问模式**：
  - **内嵌 (Embed) 相关数据**：如果数据通常一起被查询，并且关系是"一对少"，则优先考虑内嵌。这可以减少查询次数。
  - **引用 (Reference) 不常访问的数据**：如果数据关系是"一对多"或数据量很大，或者不常与父文档一起访问，则使用引用（存储 `_id`）。
- **避免巨大的、无界数组**：如果一个数组会无限增长（如评论、日志），请将其拆分到单独的集合中。这可以避免触及 16MB 的文档大小限制，并提高索引和更新性能。
- **选择合适的数据类型**：使用最合适、最紧凑的数据类型来存储数据，以节省空间和提高性能。例如，如果一个数值字段永远不会超过 20 亿，请考虑使用 32 位整数（`Int32`）而不是 64 位（`Int64`）。

## 3. 查询与写入操作

- **精确投影 (Projection)**：
  - **只请求您需要的字段**。使用投影（`projection` 或 `select`）来限制查询返回的字段。这可以显著减少网络流量和反序列化开销。
  - `db.users.find({ status: "active" }, { projection: { name: 1, email: 1, _id: 0 } })`
- **利用索引**：
  - **确保查询被索引覆盖**。使用 `.explain()` 来分析您的查询，并确保它们使用了索引，避免全集合扫描（`COLLSCAN`）。
  - **创建复合索引以匹配查询**。索引的设计应紧密匹配您的查询模式。
- **使用批量操作 (Bulk Operations)**：
  - 当需要插入、更新或删除多个文档时，使用 `bulkWrite()`（或旧版的 `insertMany()`, `updateMany()`, `deleteMany()`）而不是在循环中执行单个操作。这可以大大减少网络往返次数。
- **处理写入错误**：
  - 始终检查写入操作的结果，以确保它们成功。MongoDB 驱动程序会提供关于成功写入、失败或出现重复键错误的信息。

## 4. 错误处理与弹性

- **实现重试逻辑 (Retryable Writes)**：
  - 在遇到瞬时网络错误时，应实现重试逻辑。MongoDB 4.2+ 和最新的驱动程序默认启用了可重试写入，可以自动处理某些临时故障。
- **处理主节点故障转移**：
  - 您的应用程序应该能够优雅地处理副本集中的主节点故障转移。现代驱动程序可以自动处理这个问题，但了解其工作原理仍然很重要。

## 5. 事务 (Transactions)

- **仅在必要时使用事务**：
  - MongoDB 的原子操作（对单个文档的操作是原子的）可以满足许多用例的需求。
  - 只有当您需要在多个文档或多个集合之间保持 ACID 属性时，才使用多文档事务。
- **保持事务简短**：
  - 长时间运行的事务会持有锁，可能会影响其他操作的性能。尽量使事务的执行时间保持简短。

## 6. 安全性

- **最小权限原则**：
  - 为您的应用程序创建一个专用的数据库用户，并仅授予其完成任务所需的最小权限。不要使用具有 `root` 或 `dbAdmin` 权限的账户连接应用程序。
- **不要将敏感数据硬编码在代码中**：
  - 使用环境变量、配置文件或密钥管理服务来存储数据库凭据和其他敏感信息。
- **对用户输入进行验证**：
  - 始终验证和清理来自客户端的用户输入，以防止注入攻击（尽管 NoSQL 注入不像 SQL 注入那样常见，但仍需防范）。

遵循这些最佳实践，可以帮助您充分利用 MongoDB 的优势，构建出健壮、高效的现代应用程序。
